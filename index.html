<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ—æµ·é“æ—…éŠåŠ©æ‰‹</title>
    
    <!-- â˜…â˜…â˜… APP ICON è¨­å®š (å·²å¹«æ‚¨åŠ å…¥) â˜…â˜…â˜… -->
    <link rel="icon" type="image/svg+xml" href="./icon.svg">
    <link rel="apple-touch-icon" href="./icon.png">
    
    <!-- 1. å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. å¼•å…¥ React å’Œç›¸é—œå·¥å…· -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.303.0"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. è‡ªå®šç¾©æ¨£å¼ -->
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body {
            background-color: #2E4057; 
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #2E4057;
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; color: #F4B942; font-size: 1.5rem; font-weight: bold;
        }
        body:has(#root:not(:empty)) .loading-screen { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: fadeIn 0.2s ease-out forwards; }
    </style>
</head>
<body>
    <div class="loading-screen">æ­£åœ¨è¼‰å…¥åŒ—æµ·é“ä¹‹æ—…...</div>
    <div id="root"></div>

    <!-- 4. ä¸»ç¨‹å¼ç¢¼ -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useCallback, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Calendar, CreditCard, DollarSign, ShoppingBag, Utensils, MapPin, Shirt, Snowflake, 
            Plus, Settings, Plane, Clock, Wallet, Info, Gamepad2, AlertTriangle, CloudRain, 
            X, CheckCircle, Trash2, Sun, Cloud, Wind, Gift, Edit3, Wand2, Pencil, RotateCcw, 
            BedDouble, Loader2, Coffee, UtensilsCrossed, PlaneTakeoff, PlaneLanding, Bus, ChefHat, 
            Lightbulb, ChevronDown, Thermometer, Image as ImageIcon, Upload, Smartphone, 
            Store, Banknote, Zap, RotateCw, AlertCircle, Trees, Building2, LandPlot,
            Link as LinkIcon, ExternalLink, Bookmark, Search, Save, Filter, User, Users, Heart, ShoppingCart, Calculator
        } from 'lucide-react';

        const HideScrollbarStyle = () => (
            <style>{`.no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }`}</style>
        );

        const safeJsonParse = (key, fallback) => {
            try {
                const saved = localStorage.getItem(key);
                if (!saved || saved === "undefined") return fallback;
                return JSON.parse(saved);
            } catch (e) {
                console.error(`Error parsing ${key}`, e);
                return fallback;
            }
        };

        const INITIAL_CASH = 21622;
        const EXCHANGE_RATE = 0.2; 
        
        const LOCATION_COORDS = {
            'æ´çˆºæ¹–': { lat: 42.585, lon: 140.835 }, 'æ–°åƒæ­²æ©Ÿå ´': { lat: 42.793, lon: 141.693 },
            'æ˜­å’Œæ–°å±±': { lat: 42.543, lon: 140.858 }, 'å‡½é¤¨': { lat: 41.768, lon: 140.736 },
            'å¤§æ²¼å…¬åœ’': { lat: 41.981, lon: 140.669 }, 'ç™»åˆ¥': { lat: 42.412, lon: 141.106 },
            'å°æ¨½': { lat: 43.190, lon: 140.994 }, 'æœ­å¹Œ': { lat: 43.061, lon: 141.354 },
            'ç‹¸å°è·¯': { lat: 43.057, lon: 141.351 }, 'æ¡ƒåœ’æ©Ÿå ´': { lat: 25.079, lon: 121.234 },
            'å¤§æ²¼': { lat: 41.981, lon: 140.669 }, 'ä¿®é“é™¢': { lat: 41.768, lon: 140.736 },
            'é‡‘æ£®å€‰åº«': { lat: 41.768, lon: 140.736 }, 'æµ·é®®å¸‚å ´': { lat: 41.768, lon: 140.736 },
            'é›ªç›†': { lat: 41.981, lon: 140.669 }, 'åŒ—ä¸€ç¡å­': { lat: 43.190, lon: 140.994 },
            'è’¸æ°£é˜': { lat: 43.190, lon: 140.994 }, 'éŸ³æ¨‚ç›’å ‚': { lat: 43.190, lon: 140.994 },
            'å¤§é€šå…¬åœ’': { lat: 43.061, lon: 141.354 }, 'å…ç¨…åº—': { lat: 43.061, lon: 141.354 },
            'å”å‰è»»å¾·': { lat: 43.057, lon: 141.351 }, 'æ¹¯æ¾¤ç¥ç¤¾': { lat: 42.412, lon: 141.106 }
        };

        const DEFAULT_ITINERARY = [
            {
                date: '1/8 (å››)', shortDate: '1/8', location: 'å°åŒ— âœˆ åƒæ­² -> æ´çˆºæ¹–', weather: 'å¤šé›²æ™‚é›ª', temp: '-3Â°C ~ -6Â°C',
                clothing: 'å»ºè­°æ´‹è”¥å¼ç©¿æ­ã€‚å°ç£ç©¿è–„é•·è¢–+åšå¤–å¥—ï¼Œä¸‹æ©Ÿå¾Œå†åŠ ç™¼ç†±è¡£ã€‚',
                image: 'https://images.unsplash.com/photo-1542051841857-5f90071e7989?q=80&w=1200&auto=format&fit=crop', 
                hotel: 'æ´çˆºæ¹–å¤ªé™½å®®åº¦å‡é£¯åº—', hotelAddress: 'æ—¥æœ¬åŒ—æµ·é“æœ‰ç éƒ¡å£¯ç¥ç”ºæ´çˆºæ¹–æº«æ³‰ 7-1',
                flight: { type: 'departure', code: 'CI2130', time: '05:50 - 10:30', duration: '03:40', gather: '03:50 @ æ¡ƒåœ’æ©Ÿå ´ T2' },
                meals: { breakfast: 'æº«æš–çš„å®¶', lunch: 'æ©Ÿä¸Šé¤é£²', dinner: 'é£¯åº—è‡ªåŠ©é¤', recommendations: { lunch: ['é›™æœˆè¯å', 'é™½æ˜æ˜¥å¤©è”¬é£Ÿ'], dinner: ['ç‚¸å¤©å©¦ç¾…', 'æ—¥å¼ç‡‰ç‰›è‚‰'] } },
                spots: [
                    { name: 'æ¡ƒåœ’æ©Ÿå ´é›†åˆ (03:50)', type: 'indoor', desc: 'ğŸ“ T2 è¯èˆª7-8è™Ÿæ«ƒå°é›†åˆã€‚', tips: 'æª¢æŸ¥è­·ç…§æ•ˆæœŸã€‚' },
                    { name: 'æ–°åƒæ­²æ©Ÿå ´', type: 'indoor', desc: '10:30 æŠµé”ã€‚âš ï¸ å‡ºé—œå¾Œç›´æ¥æ­è»Šï¼Œç„¡é€›è¡—æ™‚é–“ã€‚', tips: 'æƒ³é€›è¡—è«‹ç­‰æœ€å¾Œä¸€å¤©ã€‚' },
                    { name: 'æ˜­å’Œæ–°å±±', type: 'outdoor', busTime: 'ç´„ 1.5 å°æ™‚', desc: 'æ´»ç«å±±æ™¯è§€ã€‚', food: 'å“ˆå¯†ç“œå†°æ·‡æ·‹', souvenir: 'è—¥ç”¨é¦¬æ²¹' },
                    { name: 'æ˜­å’Œæ–°å±±ç†Šç‰§å ´', type: 'outdoor', desc: 'è¿‘è·é›¢è§€å¯Ÿæ£•ç†Šã€‚', food: 'ç†Šé¤…ä¹¾', game: 'æ‰­è›‹æ©Ÿ' },
                    { name: 'æ´çˆºæ¹–æº«æ³‰', type: 'outdoor', busTime: 'ç´„ 15 åˆ†', desc: 'ä¸å‡æ¹–ï¼Œæ™šä¸Šæœ‰ç‡ˆé£¾ã€‚', food: 'Wakasaimoç”œé»' },
                    { name: 'æŠµé”é£¯åº—', type: 'indoor', isHotel: true, desc: 'æ´çˆºæ¹–å¤ªé™½å®®åº¦å‡é£¯åº—ã€‚\nğŸ“ åœ°å€ï¼šæ—¥æœ¬åŒ—æµ·é“æœ‰ç éƒ¡å£¯ç¥ç”ºæ´çˆºæ¹–æº«æ³‰ 7-1\nğŸ“ é›»è©±ï¼š+81-142-75-1111' }
                ]
            },
            {
                date: '1/9 (äº”)', shortDate: '1/9', location: 'å¤§æ²¼å…¬åœ’ -> å‡½é¤¨å¤œæ™¯', weather: 'å¤§é›ª/å¼·é¢¨', temp: '-5Â°C ~ -9Â°C',
                clothing: 'â˜…é‡é»ï¼šé˜²æ°´é˜²é¢¨ã€‚ç©é›ªå‹™å¿…ç©¿ã€Œé˜²æ»‘é˜²æ°´é›ªé´ã€èˆ‡ã€Œé˜²æ°´è¤²ã€ã€‚å‡½é¤¨å±±é¢¨å¤§åˆºéª¨ï¼Œå¿…å‚™æ¯›å¸½åœå·¾ã€‚',
                image: 'https://images.unsplash.com/photo-1533050487297-09b450131914?q=80&w=1200&auto=format&fit=crop', 
                hotel: 'å‡½é¤¨æ¹¯ä¹‹å·æº«æ³‰ (HEISEIKAN)', hotelAddress: 'æ—¥æœ¬åŒ—æµ·é“å‡½é¤¨å¸‚æ¹¯å·ç”º 1 ä¸ç›® 3-8',
                meals: { breakfast: 'é£¯åº—å…§', lunch: 'æµ·é®®å°ç«é‹', dinner: 'é£¯åº—å…§', recommendations: { breakfast: ['è‡ªè£½æµ·é®®ä¸¼', 'åŒ—æµ·é“ç‰›å¥¶'], dinner: ['ç”Ÿé­šç‰‡', 'èƒèŸ¹'] } },
                spots: [
                    { name: 'é£¯åº—å‡ºç™¼', type: 'indoor', isHotel: true, desc: 'æ—©é¤å¾Œå‡ºç™¼ã€‚' },
                    { name: 'å¤§æ²¼åœ‹å®šå…¬åœ’', type: 'outdoor', busTime: 'ç´„ 2 å°æ™‚', desc: 'æ–°æ—¥æœ¬ä¸‰æ™¯ã€‚', food: 'æ²¼ä¹‹å®¶ç³°å­' },
                    { name: 'é›ªç›†æˆ²é›ª', type: 'outdoor', desc: 'é«”é©—é›ªä¸Šæ´»å‹•ã€‚' },
                    { name: 'ç™¾å¹´å¥³å­ä¿®é“é™¢', type: 'outdoor', busTime: 'ç´„ 50 åˆ†', desc: 'èŠåš´ç´…ç£šå»ºç¯‰ã€‚', food: 'å¸‚æ°‘ä¹‹æ£®ç‰›å¥¶éœœæ·‡æ·‹', souvenir: 'ç‘ªå¾·è“®è›‹ç³•' },
                    { name: 'é‡‘æ£®å€‰åº«ç¾¤', type: 'mixed', busTime: 'ç´„ 30 åˆ†', desc: 'æ˜æ²»æ™‚ä»£ç´…ç£šå€‰åº«ã€‚', food: 'Snaffle\'s / Petite Merveille', souvenir: 'èµ·å¸è›‹ç³•' },
                    { name: 'å‡½é¤¨çºœè»Š', type: 'outdoor', busTime: 'ç´„ 15 åˆ†', desc: 'ä¸–ç•Œä¸‰å¤§å¤œæ™¯ã€‚', souvenir: 'é™å®šç£éµ' },
                    { name: 'æŠµé”é£¯åº—', type: 'indoor', isHotel: true, desc: 'å‡½é¤¨æ¹¯ä¹‹å·æº«æ³‰ (HEISEIKAN)ã€‚\nğŸ“ åœ°å€ï¼šæ—¥æœ¬åŒ—æµ·é“å‡½é¤¨å¸‚æ¹¯å·ç”º 1 ä¸ç›® 3-8' }
                ]
            },
            {
                date: '1/10 (å…­)', shortDate: '1/10', location: 'å‡½é¤¨ -> ç™»åˆ¥', weather: 'é›ªè½‰å¤šé›²', temp: '-4Â°C ~ -8Â°C',
                clothing: 'â˜…é‡é»ï¼šä¿æš–çºŒèˆªåŠ›ã€‚ä¸Šåˆæˆ¶å¤–ä¹…ç«™ï¼Œå»ºè­°è²¼æš–æš–åŒ…ã€‚ä¸‹åˆæº«æ³‰è¡—å®¤å…§å¤–é€²å‡ºï¼Œå»ºè­°æ´‹è”¥å¼ç©¿æ­ã€‚',
                image: 'https://images.unsplash.com/photo-1598439210625-5067c578f3f6?q=80&w=1200&auto=format&fit=crop', 
                hotel: 'ç™»åˆ¥æº«æ³‰ (HOTEL MAHOROBA)', hotelAddress: 'æ—¥æœ¬åŒ—æµ·é“ç™»åˆ¥å¸‚ç™»åˆ¥æº«æ³‰ç”º 65',
                meals: { breakfast: 'é£¯åº—å…§', lunch: 'å£½å–œç‡’åƒåˆ°é£½', dinner: 'é£¯åº—å…§', recommendations: { breakfast: ['æµ·é®®ä¸¼', 'ç‰å­ç‡’'], dinner: ['èƒèŸ¹åƒåˆ°é£½', 'ç¾åˆ‡ç‰›æ’'] } },
                spots: [
                    { name: 'é£¯åº—å‡ºç™¼', type: 'indoor', isHotel: true, desc: 'æ—©é¤å¾Œå‡ºç™¼ã€‚' },
                    { name: 'å‡½é¤¨æœå¸‚', type: 'mixed', desc: 'é«”é©—é‡£çƒè³Šã€‚', food: 'æµ·è†½è“‹é£¯', souvenir: 'å¹²è²ç³–' },
                    { name: 'ç™»åˆ¥å°¼å…‹æ–¯æµ·æ´‹å…¬åœ’', type: 'mixed', busTime: 'ç´„ 3.5 å°æ™‚', desc: 'ä¼éµæ•£æ­¥ã€‚', schedule: [{name:'ä¼éµéŠè¡Œ', time:'11:00/14:15'}, {name:'æµ·è±šè¡¨æ¼”', time:'11:25'}] },
                    { name: 'ç™»åˆ¥åœ°ç„è°·', type: 'outdoor', busTime: 'ç´„ 15 åˆ†', desc: 'ç«å±±åœ°å½¢æ™¯è§€ã€‚' },
                    { name: 'æ¹¯æ¾¤ç¥ç¤¾', type: 'outdoor', desc: 'æº«æ³‰å®ˆè­·ç¥ã€‚', souvenir: 'æº«æ³‰å¾¡å®ˆ' },
                    { name: 'ç™»åˆ¥æº«æ³‰è¡—', type: 'outdoor', desc: 'é–»é­”å ‚è®Šè‡‰ç§€ã€‚', food: 'é–»é­”ç‚’éºµ', tips: 'è®Šè‡‰ç§€æœ‰å›ºå®šæ™‚é–“ã€‚' },
                    { name: 'æŠµé”é£¯åº—', type: 'indoor', isHotel: true, desc: 'ç™»åˆ¥æº«æ³‰ (HOTEL MAHOROBA)ã€‚\nğŸ“ åœ°å€ï¼šæ—¥æœ¬åŒ—æµ·é“ç™»åˆ¥å¸‚ç™»åˆ¥æº«æ³‰ç”º 65' }
                ]
            },
            {
                date: '1/11 (æ—¥)', shortDate: '1/11', location: 'å°æ¨½ -> æœ­å¹Œ', weather: 'æ™´æ™‚å¤šé›²', temp: '-6Â°C ~ -10Â°C',
                clothing: 'â˜…é‡é»ï¼šé¿å…çˆ†æ±—ã€‚æœ¬æ—¥å¸‚å€é€›è¡—ç‚ºä¸»ï¼Œå®¤å…§æš–æ°£å¼·ã€‚âŒå‹¿ç©¿é«˜é ˜æ¯›è¡£ã€‚â­•å»ºè­°æ™®é€šç™¼ç†±è¡£+æ˜“è„«é‡ç¹”è¡«+åšå¤§è¡£ã€‚',
                image: 'https://images.unsplash.com/photo-1542931287-023b922fa89b?q=80&w=1200&auto=format&fit=crop', 
                hotel: 'æœ­å¹Œå…¬åœ’ç²¾å“é…’åº—', hotelAddress: 'æ—¥æœ¬åŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®å€å— 9 æ¢è¥¿ 2 ä¸ç›®',
                meals: { breakfast: 'é£¯åº—å…§', lunch: 'å°æ¨½é¢¨å‘³é¤', dinner: 'ä¸‰å¤§èŸ¹åƒåˆ°é£½', recommendations: { breakfast: ['æµ·é®®ä¸¼'], dinner: ['å¸ç‹èŸ¹', 'æˆå‰æ€æ±—çƒ¤è‚‰'] } },
                spots: [
                    { name: 'é£¯åº—å‡ºç™¼', type: 'indoor', isHotel: true, desc: 'æ—©é¤å¾Œå‡ºç™¼ã€‚' },
                    { name: 'å…ç¨…åº—', type: 'indoor', busTime: 'ç´„ 1.5 å°æ™‚', desc: 'è³¼ç‰©ç«™ã€‚', souvenir: 'ä¿é¤Šå“' },
                    { name: 'å°æ¨½å¸‚æµªæ¼«éŠ', type: 'mixed', busTime: 'ç´„ 45 åˆ†', desc: 'é‹æ²³ã€ç¡å­é¤¨ã€éŸ³æ¨‚ç›’å ‚ã€‚', food: 'LeTAO / åŒ—è“æ¨“ / ç‚¸é­šæ¿', tips: 'å¯å»å”å‰è»»å¾·å°æ¨½åº—ã€‚' },
                    { name: 'å°æ¨½é‹æ²³', type: 'outdoor', desc: 'æµªæ¼«é‹æ²³ç•”ã€‚' },
                    { name: 'åŒ—ä¸€ç¡å­é¤¨', type: 'indoor', desc: 'ç»ç’ƒå·¥è—ã€‚' },
                    { name: 'éŸ³æ¨‚ç›’å ‚', type: 'indoor', desc: 'å„å¼éŸ³æ¨‚ç›’ã€‚' },
                    { name: 'å¤§é€šå…¬åœ’', type: 'outdoor', busTime: 'ç´„ 50 åˆ†', desc: 'ç™½è‰²ç‡ˆæ¨¹ç¯€ã€‚' },
                    { name: 'ç‹¸å°è·¯å•†åº—è¡—', type: 'mixed', desc: 'è—¥å¦èˆ‡å”å‰è»»å¾·ã€‚', food: 'æ¹¯å’–å“©', souvenir: 'è—¥å¦/ç«¹è¼ªéºµåŒ…' },
                    { name: 'æŠµé”é£¯åº—', type: 'indoor', isHotel: true, desc: 'æœ­å¹Œå…¬åœ’ç²¾å“é…’åº— (HOTEL MYSTAYS PREMIER SAPPORO PARK)ã€‚\nğŸ“ åœ°å€ï¼šæ—¥æœ¬åŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®å€å— 9 æ¢è¥¿ 2 ä¸ç›® 2-10' }
                ]
            },
            {
                date: '1/12 (ä¸€)', shortDate: '1/12', location: 'æœ­å¹Œ -> æ©Ÿå ´', weather: 'å¤šé›²', temp: '-2Â°C ~ -5Â°C',
                clothing: 'â˜…é‡é»ï¼šå›ç¨‹èˆ’é©ã€‚å»ºè­°ç©¿å¯¬é¬†è¡£ç‰©èˆ‡å¥½ç©¿è„«çš„é‹ã€‚åšå¤–å¥—è«‹æ‰‹ææˆ–å¡è¡Œæç®±ã€‚',
                image: 'https://images.unsplash.com/photo-1596394516093-501ba68a0ba6?q=80&w=1200&auto=format&fit=crop', 
                hotel: 'æº«æš–çš„å®¶',
                flight: { type: 'return', code: 'CI2131', time: '11:30 - 15:05', duration: '-', gather: '09:00 å‰æŠµé”æ©Ÿå ´' },
                meals: { breakfast: 'é£¯åº—å…§', lunch: 'æ©Ÿä¸Šé¤', dinner: 'æº«æš–çš„å®¶', recommendations: { breakfast: ['æ¹¯å’–å“©', 'ç‰›å¥¶'] } },
                spots: [
                    { name: 'é£¯åº—å‡ºç™¼', type: 'indoor', isHotel: true, desc: 'æ—©é¤å¾Œå‰å¾€æ©Ÿå ´ã€‚' },
                    { name: 'æ–°åƒæ­²æ©Ÿå ´', type: 'indoor', busTime: 'ç´„ 1 å°æ™‚', desc: 'æœ€å¾Œæ¡è²·æ©Ÿæœƒã€‚', food: 'ç‰ç±³éºµåŒ…/ä¸€å¹»æ‹‰éºµ', souvenir: 'è–¯æ¢ä¸‰å…„å¼Ÿ/ROYCE/ç„¦ç³–ç‰›å¥¶ç³–', tips: 'åœ‹å…§ç·šå•†åº—è¼ƒå¤šã€‚' }
                ]
            }
        ];

        // --- Helper Components & Functions ---

        const getWeatherInfo = (code) => {
            if (code === undefined) return { label: 'è¼‰å…¥ä¸­', icon: Loader2, color: 'text-[#819FA1]' }; 
            if (code === 0) return { label: 'æ™´æœ—', icon: Sun, color: 'text-[#F4B942]' }; 
            if (code >= 1 && code <= 3) return { label: 'å¤šé›²', icon: Cloud, color: 'text-[#EDF6FC]' }; 
            if (code >= 45 && code <= 48) return { label: 'éœ§', icon: Cloud, color: 'text-[#819FA1]' }; 
            if (code >= 51 && code <= 67) return { label: 'é›¨', icon: CloudRain, color: 'text-[#819FA1]' }; 
            if (code >= 71 && code <= 77) return { label: 'é›ª', icon: Snowflake, color: 'text-[#EDF6FC]' }; 
            if (code >= 80 && code <= 82) return { label: 'é™£é›¨', icon: CloudRain, color: 'text-[#819FA1]' }; 
            if (code >= 85 && code <= 86) return { label: 'æš´é›ª', icon: Snowflake, color: 'text-white' };
            return { label: 'é™°å¤©', icon: Cloud, color: 'text-[#819FA1]' };
        };

        const useWeather = (locationName) => {
            const [weather, setWeather] = useState(null);
            const [loading, setLoading] = useState(true);
            useEffect(() => {
                let coords = null;
                for (const key in LOCATION_COORDS) {
                    if (locationName.includes(key)) { coords = LOCATION_COORDS[key]; break; }
                }
                if (!coords && locationName.includes('æœ­å¹Œ')) coords = LOCATION_COORDS['æœ­å¹Œ']; 
                if (!coords && locationName.includes('æ©Ÿå ´')) coords = LOCATION_COORDS['æ–°åƒæ­²æ©Ÿå ´'];
                if (!coords) { setLoading(false); return; }
                
                let isMounted = true;
                const fetchWeather = async () => {
                    try {
                        setLoading(true);
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true&timezone=Asia%2FTokyo`);
                        const data = await res.json();
                        if (isMounted) setWeather(data.current_weather);
                    } catch (error) { console.error(error); } 
                    finally { if (isMounted) setLoading(false); }
                };
                fetchWeather();
                return () => { isMounted = false; };
            }, [locationName]);
            return { weather, loading };
        };

        const SpotWeatherBadge = React.memo(({ locationName }) => {
            const { weather, loading } = useWeather(locationName);
            if (loading) return <span className="text-[9px] text-[#819FA1] flex items-center gap-1"><Loader2 size={8} className="animate-spin"/> Weather...</span>;
            if (!weather) return null;
            const { icon: Icon, color } = getWeatherInfo(weather.weathercode);
            return (
                <div className={`flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-[#2E4057]/80 border border-[#819FA1]/30 backdrop-blur-sm ${color}`}>
                    <Icon size={10} /> <span className="text-[9px] font-mono font-bold text-[#EDF6FC]">{weather.temperature}Â°C</span>
                </div>
            );
        });

        const LuxurySnowfall = React.memo(({ intensity = 'normal' }) => {
            const snowflakes = useMemo(() => Array.from({ length: intensity === 'heavy' ? 40 : 20 }).map((_, i) => ({
                id: i, left: `${Math.random() * 100}%`, animationDuration: `${Math.random() * 8 + 6}s`, animationDelay: `${Math.random() * 5}s`, opacity: Math.random() * 0.5 + 0.2, size: Math.random() * 3 + 1,
            })), [intensity]);
            return (
                <div className="absolute inset-0 pointer-events-none overflow-hidden z-10">
                    {snowflakes.map((flake) => (
                        <div key={flake.id} className="absolute rounded-full bg-[#F4B942] shadow-[0_0_4px_#F4B942]" style={{ left: flake.left, top: '-10px', width: `${flake.size}px`, height: `${flake.size}px`, opacity: flake.opacity, animation: `fall ${flake.animationDuration} linear infinite`, animationDelay: flake.animationDelay }} />
                    ))}
                    <style>{`@keyframes fall { 0% { transform: translateY(-10px) translateX(0px); opacity: 0; } 10% { opacity: 0.8; } 100% { transform: translateY(100vh) translateX(-20px); opacity: 0; } }`}</style>
                </div>
            );
        });

        const LuxurySnowman = ({ weather, clothing }) => {
            const isHeavySnow = weather.includes('å¤§é›ª') || weather.includes('å¼·é¢¨');
            const isSunny = weather.includes('æ™´');
            const hasHat = clothing.includes('å¸½'), hasScarf = clothing.includes('åœå·¾'), hasCoat = clothing.includes('å¤–å¥—');
            return (
                <div className="absolute bottom-20 right-6 z-20 transform transition-all duration-1000 hover:scale-105 origin-bottom drop-shadow-2xl pointer-events-none">
                    <svg width="120" height="150" viewBox="0 0 120 150">
                        <defs><linearGradient id="bodyGradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stopColor="#EDF6FC" /><stop offset="50%" stopColor="#FFFFFF" /><stop offset="100%" stopColor="#819FA1" /></linearGradient><linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#F4B942" /><stop offset="50%" stopColor="#D97706" /><stop offset="100%" stopColor="#F4B942" /></linearGradient></defs>
                        <circle cx="60" cy="110" r="35" fill="url(#bodyGradient)" stroke="#2E4057" strokeWidth="0.5" /><circle cx="60" cy="60" r="25" fill="url(#bodyGradient)" stroke="#2E4057" strokeWidth="0.5" />
                        {hasCoat && <path d="M25 110 A 35 35 0 0 0 95 110 L 95 125 A 35 35 0 0 1 25 125 Z" fill="#2E4057" />}
                        <circle cx="60" cy="95" r="2.5" fill="url(#goldGradient)" /><circle cx="60" cy="110" r="2.5" fill="url(#goldGradient)" />
                        {!hasScarf && <g><path d="M60 78 L 50 72 L 50 84 Z" fill="#819FA1" /><path d="M60 78 L 70 72 L 70 84 Z" fill="#819FA1" /><circle cx="60" cy="78" r="3" fill="#F4B942" /></g>}
                        {(isHeavySnow || hasScarf) && <path d="M45 75 Q 60 85 75 75 L 70 100 L 50 100 Z" fill="none" stroke="url(#goldGradient)" strokeWidth="8" strokeLinecap="round" className={isHeavySnow ? "animate-pulse" : ""}/>}
                        {isSunny ? <g fill="#2E4057"><rect x="48" y="52" width="8" height="2" rx="1"/><rect x="64" y="52" width="8" height="2" rx="1"/><path d="M52 65 Q 60 70 68 65" stroke="#2E4057" strokeWidth="1.5" fill="none" /></g> : <g fill="#2E4057"><circle cx="50" cy="54" r="2" /><circle cx="70" cy="54" r="2" /><path d="M55 66 Q 60 68 65 66" stroke="#2E4057" strokeWidth="1.5" fill="none" /></g>}
                        <path d="M60 60 L 58 63 L 68 61 Z" fill="url(#goldGradient)" />
                        {hasHat ? <g><path d="M35 35 Q 60 15 85 35" fill="#819FA1" /><path d="M35 35 L 38 10 L 82 10 L 85 35" fill="#2E4057" /><rect x="32" y="32" width="56" height="6" rx="3" fill="url(#goldGradient)" /></g> : <g><path d="M35 35 L 85 35 L 85 40 L 35 40 Z" fill="#2E4057" /><path d="M42 35 L 42 10 L 78 10 L 78 35" fill="#2E4057" /><rect x="42" y="28" width="36" height="4" fill="url(#goldGradient)" /></g>}
                        <line x1="38" y1="80" x2="20" y2="65" stroke="#819FA1" strokeWidth="1.5" /><line x1="82" y1="80" x2="100" y2="65" stroke="#819FA1" strokeWidth="1.5" />
                    </svg>
                </div>
            );
        };

        const LuxuryHeader = ({ dayInfo, activeTab }) => {
            const { date, clothing, image, location } = dayInfo;
            const isItinerary = activeTab === 'itinerary';
            const locationKey = location.includes('->') ? location.split('->')[1].trim() : location.split(' ')[0].trim();
            const { weather: realTimeWeather, loading: weatherLoading } = useWeather(locationKey);
            const staticWeather = dayInfo.weather; 
            const displayTemp = realTimeWeather ? `${realTimeWeather.temperature}Â°C` : dayInfo.temp;
            const displayWeatherDesc = realTimeWeather ? getWeatherInfo(realTimeWeather.weathercode).label : staticWeather;
            let WeatherIcon = Cloud;
            let snowIntensity = 'none';
            let iconColor = 'text-[#EDF6FC]';
            if (realTimeWeather) {
                const info = getWeatherInfo(realTimeWeather.weathercode);
                WeatherIcon = info.icon; iconColor = info.color;
                if (realTimeWeather.weathercode >= 71) snowIntensity = 'normal';
                if (realTimeWeather.weathercode >= 85) snowIntensity = 'heavy';
            } else {
                if (staticWeather.includes('æ™´')) { WeatherIcon = Sun; iconColor='text-[#F4B942]'; }
                else if (staticWeather.includes('é›ª')) { WeatherIcon = Snowflake; snowIntensity = 'normal'; iconColor='text-[#EDF6FC]'; }
                else if (staticWeather.includes('é›¨')) { WeatherIcon = CloudRain; iconColor='text-[#819FA1]'; }
            }
            const tabTitles = { 'shopping': 'å¿…è²·å¥½ç‰©', 'expenses': 'æ—…è²»è¨˜å¸³', 'cards': 'åˆ·å¡æ”»ç•¥', 'links': 'å¸¸ç”¨é€£çµ' };
            return (
                <header className={`relative w-full h-auto ${isItinerary ? 'min-h-[16rem]' : 'min-h-[8rem]'} bg-[#2E4057] text-[#EDF6FC] transition-all duration-1000 overflow-hidden shadow-2xl z-20 rounded-b-[2.5rem] border-b border-[#819FA1]/30 shrink-0`}>
                    <div className="absolute inset-0 z-0">
                        <img src={image} alt="Background" className="w-full h-full object-cover opacity-50" />
                        <div className="absolute inset-0 bg-gradient-to-b from-[#2E4057]/60 via-[#2E4057]/20 to-[#2E4057]"></div>
                    </div>
                    <LuxurySnowfall intensity={snowIntensity} />
                    <div className="absolute top-[-50px] right-[-50px] w-64 h-64 bg-[#F4B942]/10 rounded-full blur-[80px] z-10"></div>
                    <div className="relative z-20 p-6 pt-12 flex flex-col items-start h-full pb-10">
                        <div className="w-full animate-in fade-in slide-in-from-top duration-700">
                            <div className="flex items-center gap-3 mb-2">
                                <div className="h-[1px] w-6 bg-[#F4B942]"></div><span className="text-[10px] font-medium tracking-[0.3em] uppercase text-[#EDF6FC]/90 drop-shadow-md">Hokkaido Trip</span>
                            </div>
                            <div className="flex justify-between items-start pr-4 mb-3">
                                <div>
                                    <h1 className="text-4xl font-serif font-medium tracking-wide flex items-baseline gap-3 text-[#EDF6FC] drop-shadow-lg">{isItinerary ? date.split('(')[0] : tabTitles[activeTab]}</h1>
                                    {isItinerary && (
                                        <div className="flex items-center gap-3 mt-3 animate-in fade-in slide-in-from-left duration-500">
                                            <span className="text-xs font-bold bg-[#F4B942] px-2 py-0.5 rounded text-[#2E4057] border border-[#F4B942]/40 backdrop-blur-md">Day {dayInfo.index + 1}</span>
                                            <div className="flex items-center gap-2 bg-[#2E4057]/40 backdrop-blur-md px-3 py-1 rounded-full border border-[#EDF6FC]/10 relative min-w-[80px] justify-center">
                                                {weatherLoading ? <Loader2 size={16} className="text-[#819FA1] animate-spin" /> : <><WeatherIcon size={16} className={iconColor} /><span className="text-sm font-light text-[#EDF6FC] font-mono">{displayTemp}</span><span className="text-[10px] text-[#819FA1] ml-1">{displayWeatherDesc}</span>{realTimeWeather && <span className="absolute -top-2 -right-2 flex h-3 w-3"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-[#F4B942] opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-[#F4B942]"></span></span>}</>}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                    {isItinerary && <LuxurySnowman weather={staticWeather} clothing={clothing} />}
                </header>
            );
        };

        const Card = ({ children, className = "", onClick }) => (<div onClick={onClick} className={`bg-[#EDF6FC] rounded-2xl shadow-xl border border-[#819FA1]/30 p-5 ${className}`}>{children}</div>);
        const Button = ({ children, onClick, variant = "primary", className = "", disabled }) => {
            const base = "rounded-xl px-5 py-3 font-medium transition-all active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2 shadow-lg text-sm tracking-widest uppercase";
            const vars = { primary: "bg-[#F4B942] text-[#2E4057] hover:opacity-90 shadow-md", secondary: "bg-[#819FA1] border border-[#2E4057] text-[#EDF6FC]", danger: "bg-red-900/30 border border-red-900 text-red-400", neutral: "bg-[#2E4057] text-[#EDF6FC]", dark: "bg-[#2E4057] text-[#EDF6FC] border border-[#819FA1]" };
            return <button onClick={onClick} disabled={disabled} className={`${base} ${vars[variant]} ${className}`}>{children}</button>;
        };

        // --- Modals ---
        const Modal = ({ isOpen, onClose, title, children, actions }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-[#2E4057]/90 backdrop-blur-sm z-[100] flex items-center justify-center p-4 modal-animate" onClick={onClose}>
                    <div className="bg-[#EDF6FC] rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden border border-[#F4B942]/30" onClick={e => e.stopPropagation()}>
                        <div className="bg-[#2E4057] p-4 flex justify-between items-center"><h3 className="text-[#F4B942] font-bold text-lg">{title}</h3><button onClick={onClose}><X className="text-[#819FA1] hover:text-white" size={20}/></button></div>
                        <div className="p-5">{children}</div>
                        {actions && <div className="p-4 bg-gray-50 flex gap-3 justify-end border-t border-gray-100">{actions}</div>}
                    </div>
                </div>
            );
        };
        const Toast = ({ message, onClose }) => {
            useEffect(() => { const t = setTimeout(onClose, 2500); return () => clearTimeout(t); }, [onClose]);
            return <div className="fixed top-20 left-1/2 -translate-x-1/2 bg-[#2E4057] text-[#F4B942] px-6 py-3 rounded-full shadow-xl z-[110] flex items-center gap-2 border border-[#F4B942]/30 animate-bounce"><CheckCircle size={18} /> <span className="text-sm font-bold">{message}</span></div>;
        };
        
        // Calculator Modal (Fix 5: Enhanced precision)
        const CalculatorModal = ({ isOpen, onClose, initialValue, onConfirm }) => {
            const [expression, setExpression] = useState(initialValue ? String(initialValue) : '');
            const handleButtonClick = (val) => {
                if (val === 'C') { setExpression(''); } 
                else if (val === 'DEL') { setExpression(prev => prev.slice(0, -1)); } 
                else if (val === '=') {
                    try {
                        const result = new Function('return ' + expression)();
                        const val = Math.round(result * 10000) / 10000;
                        setExpression(String(val)); 
                    } catch (e) { setExpression('Error'); setTimeout(() => setExpression(''), 1000); }
                } else { setExpression(prev => prev + val); }
            };
            const handleConfirm = () => {
                let finalVal = expression;
                if (/[\+\-\*\/]/.test(expression)) {
                     try { 
                         const result = new Function('return ' + expression)(); 
                         finalVal = String(Math.round(result * 100) / 100); 
                     } catch (e) {}
                }
                onConfirm(finalVal);
                onClose();
            };
            if (!isOpen) return null;
            const buttons = ['7', '8', '9', '/', '4', '5', '6', '*', '1', '2', '3', '-', '0', '.', '=', '+', 'C', 'DEL'];
            return (
                <div className="fixed inset-0 bg-[#2E4057]/90 backdrop-blur-sm z-[110] flex items-center justify-center p-4 modal-animate" onClick={onClose}>
                    <div className="bg-[#EDF6FC] rounded-2xl w-full max-w-[300px] shadow-2xl overflow-hidden border border-[#F4B942]/30" onClick={e => e.stopPropagation()}>
                        <div className="bg-[#2E4057] p-4 flex justify-between items-center"><h3 className="text-[#F4B942] font-bold text-lg">è¨ˆç®—æ©Ÿ</h3><button onClick={onClose}><X className="text-[#819FA1] hover:text-white" size={20}/></button></div>
                        <div className="p-4">
                            <div className="bg-white p-4 rounded-lg text-right text-2xl font-mono text-[#2E4057] mb-4 h-16 flex items-center justify-end overflow-hidden border border-[#819FA1]/20">{expression || '0'}</div>
                            <div className="grid grid-cols-4 gap-2">{buttons.map(btn => (<button key={btn} onClick={() => handleButtonClick(btn)} className={`p-3 rounded-lg font-bold text-lg shadow-sm active:scale-95 transition-transform ${['C', 'DEL'].includes(btn) ? 'bg-red-100 text-red-600 col-span-2' : ['/', '*', '-', '+', '='].includes(btn) ? 'bg-[#F4B942]/20 text-[#D97706]' : 'bg-white text-[#2E4057]'}`}>{btn === 'DEL' ? <Trash2 size={18} className="mx-auto"/> : btn}</button>))}</div>
                            <button onClick={handleConfirm} className="w-full mt-4 py-3 bg-[#2E4057] text-[#F4B942] rounded-xl font-bold shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2"><CheckCircle size={18}/> ç¢ºèªé‡‘é¡</button>
                        </div>
                    </div>
                </div>
            );
        };

        const OutfitModal = ({ isOpen, onClose, dayInfo }) => {
            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="ç©¿æ­å»ºè­°" actions={<button onClick={onClose} className="w-full py-2 bg-[#2E4057] text-[#F4B942] rounded-lg text-xs font-bold">CLOSE</button>}>
                    <div className="flex flex-col items-center mb-4"><div className="w-12 h-12 rounded-full bg-[#2E4057] flex items-center justify-center border border-[#819FA1] mb-2 text-[#F4B942]"><Shirt size={24} /></div><p className="text-xs text-[#819FA1] uppercase tracking-widest">Day {dayInfo.index + 1} â€¢ {dayInfo.weather}</p></div>
                    <div className="space-y-4"><div className="bg-white p-4 rounded-lg border border-[#819FA1]/20 shadow-inner"><p className="text-sm text-[#2E4057] leading-relaxed text-center">{dayInfo.clothing}</p></div><div className="flex gap-4 justify-center text-[#819FA1] text-xs">{dayInfo.weather.includes('é›ª') && <span className="flex items-center gap-1.5"><Snowflake size={12} className="text-[#2E4057]"/> é˜²æ»‘é´</span>}<span className="flex items-center gap-1.5"><Thermometer size={12} className="text-rose-500"/> ä¿æš–å„ªå…ˆ</span></div></div>
                </Modal>
            );
        };
        const MealModal = ({ isOpen, onClose, mealInfo }) => {
            if (!isOpen || !mealInfo) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={mealInfo.title} actions={<button onClick={onClose} className="w-full py-2 bg-[#2E4057] text-[#F4B942] rounded-lg text-xs font-bold">CLOSE</button>}>
                    <div className="flex flex-col items-center mb-4"><div className="w-12 h-12 rounded-full bg-[#2E4057] flex items-center justify-center border border-[#819FA1] mb-2 text-[#F4B942]"><ChefHat size={24} /></div><p className="text-xs text-[#819FA1] uppercase tracking-widest">Recommended Menu</p></div>
                    <div className="space-y-2">{mealInfo.items && mealInfo.items.length > 0 ? mealInfo.items.map((item, idx) => <div key={idx} className="bg-white p-3 rounded-lg border border-[#819FA1]/10 shadow-sm text-sm text-[#2E4057] flex items-start gap-2">{item.includes('æ”»ç•¥')?<Lightbulb size={16} className="text-[#F4B942] shrink-0 mt-0.5"/>:<span className="text-[#F4B942] mt-1.5">â€¢</span>}<span className={item.includes('æ”»ç•¥')?"font-bold":""}>{item}</span></div>) : <p className="text-center text-[#819FA1] text-sm">æš«ç„¡ç‰¹åˆ¥æ¨è–¦ã€‚</p>}</div>
                </Modal>
            );
        };

        const SpotItem = ({ spot, sIdx }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const isAirport = spot.name.includes('æ©Ÿå ´') || spot.name.includes('é›†åˆ');
            const titleColor = isAirport || spot.isHotel ? 'text-[#819FA1]' : 'text-[#2E4057]';
            const getLocationTag = (type, name) => {
                if (name.includes('ç¥ç¤¾')) return { label: 'åƒæ‹œ', icon: LandPlot, color: 'bg-red-100 text-red-700 border-red-200' };
                switch(type) { case 'indoor': return { label: 'å®¤å…§', icon: Building2, color: 'bg-orange-100 text-orange-700 border-orange-200' }; case 'outdoor': return { label: 'æˆ¶å¤–', icon: Trees, color: 'bg-emerald-100 text-emerald-700 border-emerald-200' }; case 'mixed': return { label: 'åŠæˆ¶å¤–', icon: Store, color: 'bg-blue-100 text-blue-700 border-blue-200' }; default: return null; }
            };
            const locTag = getLocationTag(spot.type, spot.name);
            return (
                <div className="relative pl-6 border-l border-[#819FA1]/30 group hover:border-[#004346] transition-colors duration-300">
                    <div className={`absolute -left-[5px] top-0 w-2.5 h-2.5 rounded-full border ${isAirport||spot.isHotel?'bg-[#819FA1] border-[#819FA1]':'bg-[#004346] border-[#004346]'} shadow-sm`}></div>
                    <div className="flex justify-between items-start mb-2 cursor-pointer" onClick={() => setIsExpanded(!isExpanded)}>
                        <div className="flex flex-col gap-1.5 w-full">
                            <div className="flex items-center gap-2 flex-wrap">
                                {spot.isHotel && <BedDouble size={18} className="text-[#224870] shrink-0 mt-0.5"/>}
                                <h4 className={`font-medium ${titleColor} text-lg leading-tight font-serif flex items-center gap-1`}>{spot.name} <ChevronDown size={16} className={`text-[#819FA1] transition-transform ${isExpanded?'rotate-180':''}`} /></h4>
                                {locTag && <div className={`flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] border ${locTag.color}`}><locTag.icon size={10} /><span>{locTag.label}</span></div>}
                                {!isAirport && !spot.isHotel && <SpotWeatherBadge locationName={spot.name} />}
                            </div>
                            {spot.busTime && <div className="flex items-center gap-1.5 text-[#2E4057] bg-white/50 px-2 py-1 rounded w-fit text-[10px] mt-0.5 border border-[#819FA1]/10"><Bus size={12} className="shrink-0"/><span>è»Šç¨‹ {spot.busTime.replace('ç´„','').trim()}</span></div>}
                        </div>
                    </div>
                    <div className={`grid transition-all duration-300 ease-in-out ${isExpanded ? 'grid-rows-[1fr] opacity-100 mb-4' : 'grid-rows-[0fr] opacity-0'}`}><div className="overflow-hidden"><p className="text-sm text-[#2E4057]/80 font-medium leading-relaxed mb-3 whitespace-pre-wrap">{spot.desc}</p><div className="space-y-3">{spot.schedule && <div className="bg-white p-3 rounded-lg border border-[#819FA1]/10 shadow-sm"><p className="text-xs font-bold text-[#2E4057] mb-2">è¡¨æ¼”æ™‚é–“è¡¨</p>{spot.schedule.map((sch, i) => <div key={i} className="flex justify-between text-xs text-[#819FA1] border-b border-dashed border-[#819FA1]/10 last:border-0 py-1"><span>{sch.name}</span><span className="font-mono">{sch.time}</span></div>)}</div>}{spot.food&&spot.food!=='-'&&<div className="flex items-start gap-3 bg-white p-3 rounded-lg border border-[#819FA1]/10 shadow-sm"><div className="bg-[#2E4057]/10 p-1.5 rounded text-[#2E4057] shrink-0 border border-[#2E4057]/10"><Utensils size={14}/></div><div className="flex-1"><span className="text-xs text-[#2E4057] font-medium">{spot.food}</span></div></div>}{spot.souvenir&&spot.souvenir!=='-'&&<div className="flex items-start gap-3 bg-white p-3 rounded-lg border border-[#819FA1]/10 shadow-sm"><div className="bg-[#2E4057]/10 p-1.5 rounded text-[#2E4057] shrink-0 border border-[#2E4057]/10"><ShoppingBag size={14}/></div><div className="flex-1"><span className="text-xs text-[#2E4057] font-medium">{spot.souvenir}</span></div></div>}{spot.game&&spot.game!=='-'&&<div className="flex items-start gap-3 bg-white p-3 rounded-lg border border-[#819FA1]/10 shadow-sm"><div className="bg-[#2E4057]/10 p-1.5 rounded text-[#2E4057] shrink-0 border border-[#2E4057]/10"><Gamepad2 size={14}/></div><div className="flex-1"><span className="text-xs text-[#2E4057] font-medium">{spot.game}</span></div></div>}{spot.tips&&spot.tips!=='-'&&<div className="flex items-start gap-3 bg-red-50 p-3 rounded-lg border border-red-100 shadow-sm"><div className="text-red-400 shrink-0 mt-0.5"><AlertTriangle size={14}/></div><div className="flex-1"><span className="text-xs text-red-600 font-medium">{spot.tips}</span></div></div>}</div></div></div>
                </div>
            );
        };

        // --- Main App ---
        export default function App() {
            const [activeTab, setActiveTab] = useState('itinerary');
            const [activeDay, setActiveDay] = useState(0); 
            const [activeShoppingTab, setActiveShoppingTab] = useState('æ©Ÿå ´'); 
            const [selectedLocation, setSelectedLocation] = useState('å…¨éƒ¨'); 
            
            // UI States
            const [showOutfitModal, setShowOutfitModal] = useState(false); 
            const [showMealModal, setShowMealModal] = useState(false);
            const [selectedMealInfo, setSelectedMealInfo] = useState(null);
            const [viewImage, setViewImage] = useState(null);
            const [toastMsg, setToastMsg] = useState('');
            const [showCalculator, setShowCalculator] = useState(false);

            // Modals States
            const [confirmModal, setConfirmModal] = useState({ open: false, title: '', msg: '', onConfirm: null });
            const [promptModal, setPromptModal] = useState({ open: false, title: '', value: '', onConfirm: null });

            // Data States
            const [savedLinks, setSavedLinks] = useState(() => safeJsonParse('savedLinks', [
                { id: 1, title: 'æ—¥æœ¬æ—…éŠä¿¡ç”¨å¡æ”»ç•¥', url: 'https://www.beurlife.com/2022/09/best-credit-card-to-travel-japan.html', desc: 'è©³ç´°æ¯”è¼ƒå‰é¶´å¡ã€ç†Šæœ¬ç†Šå¡ç­‰å„ªæƒ ' }
            ]));
            const [newLinkData, setNewLinkData] = useState({ title: '', url: '' });
            const [editingLinkId, setEditingLinkId] = useState(null); 

            const [isEditingCards, setIsEditingCards] = useState(false);
            const [showAddCardModal, setShowAddCardModal] = useState(false);
            const [editingCardId, setEditingCardId] = useState(null);
            const [newCardData, setNewCardData] = useState({ name: '', reward: '', type: 'credit', color: 'bg-slate-700', desc: '', limit: '', tags: [] });

            // Shopping & Expenses
            const [showAddItemModal, setShowAddItemModal] = useState(false);
            const [smartInputText, setSmartInputText] = useState('');
            const [isSmartAnalyzing, setIsSmartAnalyzing] = useState(false);
            const [newItemData, setNewItemData] = useState({ name: '', price: '', location: '', desc: '', image: null });
            const [editingShoppingIndex, setEditingShoppingIndex] = useState(null);
            
            const [searchTerm, setSearchTerm] = useState('');
            const [newExpense, setNewExpense] = useState({ 
                date: new Date().toISOString().split('T')[0], // Default today
                item: '', 
                cost: '', 
                category: 'shopping', 
                cardId: '', 
                note: '',
                forWho: 'å€‹äºº' // NEW: Default target
            });
            const [editingExpense, setEditingExpense] = useState(null);
            const whoOptions = ['å€‹äºº', 'ç”·å‹', 'å®¶äºº', 'æœ‹å‹', 'ä»£è³¼'];
            const whoColors = { 'å€‹äºº': 'bg-blue-100 text-blue-700', 'ç”·å‹': 'bg-pink-100 text-pink-700', 'å®¶äºº': 'bg-green-100 text-green-700', 'æœ‹å‹': 'bg-orange-100 text-orange-700', 'ä»£è³¼': 'bg-purple-100 text-purple-700' };

            const [expenses, setExpenses] = useState(() => safeJsonParse('expenses', []));
            const [budget, setBudget] = useState(() => safeJsonParse('budget', 200000)); 

            const [shoppingList, setShoppingList] = useState(() => safeJsonParse('shoppingList', {
                "æ©Ÿå ´": [
                    { name: "Snow Cheese (Snow White Cheese)", price: "Â¥1,296èµ·", location: "åœ‹å…§ç·š2F", desc: "ã€2025æ’éšŠç‹ã€‘ç”Ÿé£Ÿæ„Ÿèµ·å¸å·§å…‹åŠ›ï¼Œæ¯å¤©æ—©ä¸Šå¤§æ’é•·é¾ï¼Œå¿…æ¶ã€‚", image: null },
                    { name: "Kinotoya ç¾çƒ¤èµ·å¸å¡” (ç„¼ããŸã¦ãƒãƒ¼ã‚ºã‚¿ãƒ«ãƒˆ)", price: "Â¥220/å€‹", location: "åœ‹å…§ç·š2F", desc: "æ©Ÿå ´å“¡å·¥ç¥¨é¸No.1ï¼Œå¡”çš®é…¥è„†å…§é¤¡æµå¿ƒã€‚é‚„æœ‰ã€Œæ¥µä¸Šç‰›ä¹³éœœæ·‡æ·‹ã€å¿…åƒã€‚", image: null },
                    { name: "ç¾ç‘›é¸æœ - ç‰ç±³éºµåŒ… (ã³ãˆã„ã®ã‚³ãƒ¼ãƒ³ã±ã‚“)", price: "Â¥1,300/5å…¥", location: "åœ‹å…§ç·š2F", desc: "ã€è¶…é™é‡ã€‘å®Œå…¨ä¸åŠ æ°´ï¼Œåªç”¨ç‰ç±³å’Œéºµç²‰è£½ä½œï¼Œå‡ºçˆå³ç§’æ®ºã€‚", image: null },
                    { name: "PRESS BUTTER SAND åŒ—æµ·é“é™å®š", price: "Â¥1,242èµ·", location: "åœ‹å…§ç·š2F", desc: "é™å®šã€Œç™½å·§å…‹åŠ›ç„¦ç³–ã€å£å‘³ï¼Œä½¿ç”¨åŒ—æµ·é“ç”¢å¥¶æ²¹ï¼Œæ©Ÿå ´é™å®šã€‚", image: null },
                    { name: "Caramel Kitchen - ç¾åšç„¦ç³–ç‰›å¥¶ç³– (ã‚­ãƒ£ãƒ©ãƒ¡ãƒ«ã‚­ãƒƒãƒãƒ³)", price: "Â¥1,080èµ·", location: "åœ‹å…§ç·š2F", desc: "å›ºåŠ›æœ(Glico)é«˜ç´šç‰ˆï¼Œåº—å…§éŠ…é‹ç¾ç…®ï¼Œåªæœ‰æ–°åƒæ­²æ©Ÿå ´æœ‰ã€‚", image: null },
                    { name: "Royce ç”Ÿå·§å…‹åŠ› (ç”Ÿãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ)", price: "Â¥864", location: "å…ç¨…åº—å„è™•", desc: "ç¶“å…¸ä¸æ•—ï¼Œéœ€åŠ è³¼ä¿å†·è¢‹ (Â¥100)ã€‚", image: null },
                    { name: "Jaga Pokkuru è–¯æ¢ä¸‰å…„å¼Ÿ (ã˜ã‚ƒãŒãƒãƒƒã‚¯ãƒ«)", price: "Â¥1,100", location: "å…ç¨…åº—å„è™•", desc: "äººæ‰‹ä¸€ç›’çš„ç¶“å…¸ï¼ŒåŒ—æµ·é“é¦¬éˆ´è–¯è£½ä½œï¼Œé…¥è„†æ¶®å˜´ã€‚", image: null },
                    { name: "Pokemon Store - æ©Ÿé•·çš®å¡ä¸˜ (ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆãƒ”ã‚«ãƒãƒ¥ã‚¦)", price: "Â¥1,760", location: "åœ‹å…§ç·š2F", desc: "ç©¿è‘—æ–°åƒæ­²æ©Ÿå ´åˆ¶æœçš„é™å®šçš®å¡ä¸˜ã€‚", image: null },
                    { name: "åŒ—è“æ¨“ å¤¢ä¸æ€è­°æ³¡èŠ™ (å¤¢ä¸æ€è­°)", price: "Â¥250", location: "åœ‹å…§ç·š2F", desc: "ã€ç¾å ´åƒã€‘å¤–çš®é…¥è„†ï¼Œå¡å£«é”é†¬çˆ†æ¼¿ï¼ŒCPå€¼è¶…é«˜ã€‚", image: null },
                    { name: "LeTAO è‰²å…§é€šå¤¾å¿ƒé¤…ä¹¾ (è‰²å†…é€šã‚Šãƒ•ãƒ­ãƒãƒ¼ã‚¸ãƒ¥)", price: "Â¥1,080", location: "å…ç¨…åº—", desc: "èµ·å¸å‘³æ¿ƒéƒçš„è²“èˆŒé¤…ä¹¾ï¼Œæ¯”è›‹ç³•å¥½æ”œå¸¶ï¼Œé€ç¦®é¦–é¸ã€‚", image: null },
                ],
                "ä¼´æ‰‹ç¦®": [
                    { name: "è‹¥ç‹¹èŠ‹æœ¬èˆ– - åŒ—æµ·é“ç‚¸è–¯æ¢ (åŒ—æµ·é“ã˜ã‚ƒãŒãƒƒã‚­ãƒ¼)", price: "Â¥540", location: "æ´çˆºæ¹–", desc: "å£æ„Ÿé…¥è„†å¸¶æœ‰æ˜†å¸ƒé®®å‘³ï¼Œéš±è—ç‰ˆäººæ°£ç‹ã€‚", image: null },
                    { name: "è‹¥ç‹¹èŠ‹æœ¬èˆ– - é®®å¥¶æ²¹ç´…è±†ç‚¸ç”œç”œåœˆ (ã‚ã‚“ãƒ‰ãƒ¼ãƒŠãƒ„)", price: "Â¥200", location: "æ´çˆºæ¹–æœ¬åº—", desc: "å…§é¤¡æœ‰é®®å¥¶æ²¹ï¼Œç†±ç†±åƒè¶…è®šã€‚", image: null },
                    { name: "æ˜­å’Œæ–°å±± - å“ˆå¯†ç“œæœå‡ (ãƒ”ãƒ¥ã‚¢ã‚¼ãƒªãƒ¼)", price: "Â¥540", location: "ç†Šç‰§å ´", desc: "å£æ„Ÿæœ€æ¥è¿‘çœŸå¯¦å“ˆå¯†ç“œçš„æœå‡ã€‚", image: null },
                    { name: "Petite Merveille - ä¸€å£èµ·å¸è›‹ç³• (ãƒ¡ãƒ«ãƒãƒ¼ã‚º)", price: "Â¥1,600/8å…¥", location: "å‡½é¤¨/é‡‘æ£®", desc: "å£æ„Ÿæ¯”Snaffle'sæ›´ç¶¿å¯†ï¼Œå‡½é¤¨é›™é›„ä¹‹ä¸€ã€‚", image: null },
                    { name: "Snaffle's - è’¸æ°£è›‹ç³• (è’¸ã—ç„¼ãã‚·ãƒ§ã‚³ãƒ©)", price: "Â¥1,500", location: "å‡½é¤¨", desc: "å£æ„Ÿè“¬é¬†ï¼Œå¸¸æº«å¥½æ”œå¸¶ã€‚", image: null },
                    { name: "å…­èŠ±äº­ - è‘¡è„å¥¶æ²¹å¤¾å¿ƒ (ãƒãƒ«ã‚»ã‚¤ãƒã‚¿ãƒ¼ã‚µãƒ³ãƒ‰)", price: "Â¥750/5å…¥", location: "å°æ¨½/å„è™•", desc: "ç¶“å…¸å¿…è²·ï¼Œè˜­å§†è‘¡è„é¦™æ°£æ¿ƒéƒã€‚", image: null },
                    { name: "å…­èŠ±äº­ - å¡å¸ƒå¥‡è«¾éœœé¤… (éœœã ãŸã¿)", price: "Â¥550", location: "å°æ¨½/å„è™•", desc: "å…§è¡Œäººçš„æ„›ï¼Œå£æ„Ÿåƒé…¥è„†çš„åƒå±¤æ´¾ã€‚", image: null },
                    { name: "LeTAO - é›™å±¤èµ·å¸è›‹ç³• (ãƒ‰ã‚¥ãƒ¼ãƒ–ãƒ«ãƒ•ãƒ­ãƒãƒ¼ã‚¸ãƒ¥)", price: "Â¥2,000", location: "å°æ¨½/æ©Ÿå ´", desc: "å…¥å£å³åŒ–ï¼Œå»ºè­°å›åœ‹å‰åœ¨æ©Ÿå ´è²·ä¿å†·è¢‹ã€‚", image: null },
                    { name: "LeTAO - ç´…èŒ¶å·§å…‹åŠ›å¤¾å¿ƒ (ãƒ†ãƒãƒ¯ãƒ¼ãƒ«)", price: "Â¥1,000", location: "å°æ¨½", desc: "èŒ¶é¦™æ¿ƒéƒï¼Œå¸¸æº«å¯å¸¶å›åœ‹ (æ›¿ä»£éœ€å†·è—çš„è›‹ç³•)ã€‚", image: null },
                    { name: "ã‹ã¾æ „ (Kamaei) - ç‚¸é­šæ¿ (ã²ã‚‰å¤©/ãƒ‘ãƒ³ãƒ­ãƒ¼ãƒ«)", price: "Â¥237", location: "å°æ¨½", desc: "ã€å¿…åƒé¹¹é£Ÿã€‘ç¾ç‚¸å¹³å¤©æˆ–éºµåŒ…æ²ï¼Œå•†åº—è¡—æœ«ç«¯ã€‚", image: null },
                    { name: "åŒ—è“æ¨“ - å¤¢ä¸æ€è­°æ³¡èŠ™ (å¤¢ä¸æ€è­°)", price: "Â¥250/å€‹", location: "æ–°åƒæ­²/å°æ¨½", desc: "å¤–çš®é…¥è„†ï¼Œå…§é¤¡å¡å£«é”é†¬çˆ†æ¼¿ã€‚", image: null },
                    { name: "åŒ—è“æ¨“ æœ­å¹Œæœ¬é¤¨ - åŒ—æµ·é“å»³ç«‹åœ–æ›¸é¤¨é¤…ä¹¾", price: "Â¥1,200", location: "æœ­å¹Œæœ¬é¤¨", desc: "å®‰è—¤å¿ é›„è¨­è¨ˆæœ¬é¤¨é™å®šï¼Œæ›¸æœ¬é€ å‹åŒ…è£ã€‚", image: null },
                    { name: "è—¤å´å±±è‘µåœ’ - é¬¼æ¼¬ (é¬¼æ¼¬ã‘)", price: "Â¥650", location: "ç™»åˆ¥æº«æ³‰è¡—", desc: "å±±è‘µé†ƒæ¼¬çš„æ¼¬ç‰©ï¼Œåå­—æ‡‰æ™¯ï¼Œä¸‹é…’é…é£¯çš†å®œã€‚", image: null },
                    { name: "ç™»åˆ¥å¤§æ ¼è˜­é£¯åº— - é¬¼ä¹‹é‡‘æ£’ (é¬¼ã®é‡‘æ£’)", price: "Â¥1,000", location: "ç™»åˆ¥", desc: "åƒé¬¼çš„ç‹¼ç‰™æ£’é€ å‹çš„é•·æ¢ç”œé»ã€‚", image: null },
                    { name: "ä½è—¤æ°´ç”£ - é®­é­šè·¯æ˜“æ¼¬ (é®­ã®ãƒ«ã‚¤ãƒ™æ¼¬)", price: "Â¥1,450", location: "æœ­å¹Œ/æ©Ÿå ´", desc: "æœ€é«˜ç´šæµ·é®®ä¼´æ‰‹ç¦®ï¼Œé®­é­šé†¬æ²¹æ¼¬ï¼Œé•·è¼©è¶…æ„›ã€‚", image: null },
                    { name: "ã©ã‚“ãã‚Š (DONGURI) - ç«¹è¼ªéºµåŒ… (ã¡ãã‚ãƒ‘ãƒ³)", price: "Â¥194", location: "æœ­å¹Œå¤§é€š", desc: "æœ­å¹Œéˆé­‚ç¾é£Ÿï¼éºµåŒ…åŒ…æ•´æ ¹ç«¹è¼ªèˆ‡é®ªé­šæ²™æ‹‰ã€‚", image: null },
                    { name: "ä¹¾å¹²è² (å¸†ç«‹è²æŸ±)", price: "Â¥3,000èµ·", location: "å‡½é¤¨æœå¸‚", desc: "ç…®æ¹¯ã€ç•¶é›¶é£Ÿéƒ½é©åˆï¼Œè¶Šåš¼è¶Šé¦™ã€‚", image: null },
                    { name: "æ·±æµ·é®«é­šæ²¹", price: "Â¥18,000", location: "å…‰ä¼¸/äºæ­·å±±å¤§", desc: "åœ˜å®¢å¿…æ¨ï¼Œæ˜¯å¦è³¼è²·è¦‹ä»è¦‹æ™ºã€‚", image: null },
                    { name: "è—¥ç‹ (ç—›å¯¶ç²¾)", price: "Â¥28,000", location: "å…‰ä¼¸/äºæ­·å±±å¤§", desc: "é‡å°é—œç¯€ç—›ï¼Œå–®åƒ¹æ¥µé«˜ã€‚", image: null },
                ],
                "å°ç‰©": [
                    { name: "Lucky Pierrot - å¹¸é‹è–¯æ¢é¦¬å…‹æ¯ (ãƒ©ãƒƒã‚­ãƒ¼ãƒ”ã‚¨ãƒ­)", price: "Â¥800", location: "å‡½é¤¨", desc: "å‡½é¤¨é™å®šå°ä¸‘æ¼¢å ¡å‘¨é‚Šï¼Œéå¸¸æœ‰ç‰¹è‰²ã€‚", image: null },
                    { name: "æ˜­å’Œæ–°å±± è—¥ç”¨é¦¬æ²¹", price: "Â¥3,300", location: "ç†Šç‰§å ´", desc: "æ©˜è‰²ç½è£ï¼Œä¿æ¿•æ•ˆæœæ¥µä½³ï¼Œé•·è¼©æœ€æ„›ã€‚", image: null },
                    { name: "å°æ¨½éŸ³æ¨‚ç›’", price: "Â¥3,000èµ·", location: "éŸ³æ¨‚ç›’å ‚", desc: "ç²¾ç·»æµªæ¼«ï¼Œæ¬¾å¼å¤šæ¨£ï¼Œå…·ç´€å¿µåƒ¹å€¼ã€‚", image: null },
                    { name: "æ´çˆºæ¹– æœ¨åˆ€", price: "Â¥1,500èµ·", location: "æ´çˆºæ¹–", desc: "å‹•æ¼«è¿·å¿…è²·ï¼Œå¯åˆ»å­—ã€‚", image: null },
                    { name: "åŒ—æµ·é“é™å®š æ‰­è›‹", price: "Â¥300èµ·", location: "æ©Ÿå ´/ç‹¸å°è·¯", desc: "é›ªåˆéŸ³ã€åŒ—æµ·é“å‹•ç‰©ç³»åˆ—ã€‚", image: null },
                    { name: "ç™»åˆ¥æº«æ³‰å…¥æµ´åŠ‘", price: "Â¥1,200", location: "ç™»åˆ¥", desc: "åœ¨å®¶ä¹Ÿèƒ½äº«å—ç¡«ç£ºæ³‰ã€‚", image: null },
                ],
                "ç¾å¦": [
                    { name: "LuLuLun åŒ—æµ·é“é™å®šé¢è†œ", price: "Â¥1,760/ç›’", location: "è—¥å¦åº—/æ©Ÿå ´", desc: "è–°è¡£è‰/å“ˆå¯†ç“œé™å®šé¦™æ°£ï¼Œ7ç‰‡x5è¢‹å…¥ï¼Œé€ç¦®é¦–é¸ã€‚", image: null },
                    { name: "SHIRO çš‚é¦™é¦™æ°´", price: "Â¥4,180", location: "æœ­å¹ŒStella Place", desc: "åŒ—æµ·é“ç™¼è·¡çš„å¤©ç„¶ç³»å“ç‰Œï¼Œå‘³é“æ¸…å†·é«˜ç´šã€‚", image: null },
                    { name: "HABA ç´”æµ·è§’é¯Šç²¾ç´”æ¶²", price: "Â¥1,540èµ·", location: "ç™¾è²¨/è—¥å¦", desc: "åŒ—æµ·é“ç„¡æ·»åŠ è€ç‰Œï¼Œä¸€æ»´é–æ°´ï¼Œåƒ¹æ ¼ç´„å°ç£6æŠ˜ã€‚", image: null },
                    { name: "åŒ—æµ·é“ç´”é¦¬æ²¹æœ¬èˆ– é¦¬æ²¹", price: "Â¥1,100", location: "ç‹¸å°è·¯/æ©Ÿå ´", desc: "100%ç´”é¦¬æ²¹ï¼Œæ»‹æ½¤åº¦æ¥µé«˜ï¼Œé©åˆä¹¾ç‡¥è‚Œè†šã€‚", image: null },
                    { name: "Curel ç‚æ½¤ ä¿æ¿•ä¹³éœœ", price: "Â¥2,500", location: "å¤§åœ‹/æ¾æœ¬æ¸…", desc: "ä¹¾ç‡¥æ•æ„Ÿè‚Œæ•‘æ˜Ÿï¼Œåƒ¹æ ¼æ¯”å°ç£ç”œå¾ˆå¤šã€‚", image: null },
                ],
                "è—¥ç‰©": [
                    { name: "åˆåˆ©ä»–å‘½ EX Plus", price: "Â¥5,980", location: "è—¥å¦åº—", desc: "ç·©è§£çœ¼ç›ç–²å‹ã€è‚©é ¸åƒµç¡¬ï¼Œåƒ¹å·®å¤§å¿…è²·ã€‚", image: null },
                    { name: "EVE æ­¢ç—›è—¥", price: "Â¥798", location: "è—¥å¦åº—", desc: "é‡å°é ­ç—›ç”Ÿç†ç—›ï¼Œè—è‰²åŒ…è£ä¸å—œç¡ã€‚", image: null },
                    { name: "å¤§æ­£ç™¾ä¿èƒ½æ„Ÿå†’è—¥", price: "Â¥1,380", location: "è—¥å¦åº—", desc: "ç²‰æœ«ç‹€ï¼Œæ„Ÿå†’åˆæœŸæœç”¨æ•ˆæœä½³ã€‚", image: null },
                    { name: "Wakamoto è‹¥å…ƒéŒ ", price: "Â¥1,880", location: "è—¥å¦åº—", desc: "è…¸èƒƒè—¥ï¼Œå¹«åŠ©æ¶ˆåŒ–ï¼Œå®¶åº­å¸¸å‚™ã€‚", image: null },
                    { name: "æ›¼ç§€é›·æ•¦ ADä¹³è†", price: "Â¥700", location: "è—¥å¦åº—", desc: "æ­¢ç„¶æ¶ˆç‚ï¼Œé©åˆä¹¾ç‡¥ç™¼ç™¢è‚Œè†šã€‚", image: null },
                ],
                "3C": [
                    { name: "Panasonicå¹é¢¨æ©Ÿ", price: "Â¥38,000", location: "Bic Camera", desc: "æœ€æ–°å‹è™Ÿ NA0Jï¼Œä¿æ¿•æ•ˆæœæ›´å¼·ã€‚", image: null },
                    { name: "Sony é™å™ªè€³æ©Ÿ", price: "Â¥40,000", location: "Yodobashi", desc: "WH-1000XM5ï¼Œé™å™ªæ•ˆæœé ‚ç´šï¼Œé©åˆæ­æ©Ÿã€‚", image: null },
                    { name: "Nintendo Switch éŠæˆ²ç‰‡", price: "Â¥5,000èµ·", location: "Bic Camera", desc: "æ¯”å°ç£ä¾¿å®œï¼Œéƒ¨åˆ†æœ‰ä¸­æ–‡ç‰ˆã€‚", image: null },
                    { name: "å¯Œå£«æ‹ç«‹å¾—åº•ç‰‡", price: "Â¥800èµ·", location: "Yodobashi", desc: "æ—¥æœ¬é™å®šæ¬¾å¼ï¼Œåƒ¹æ ¼è¼ƒå„ªæƒ ã€‚", image: null },
                ],
            }));

            // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå®šç¾©é è¨­å¡ç‰‡è³‡æ–™å¸¸æ•¸ (Fix 2) â˜…â˜…â˜…
            const DEFAULT_CARDS_DATA = [
                { id: 'jihe', name: 'è¯é‚¦å‰é¶´å¡', reward: 'æœ€é«˜ 7% (Apple Pay)', type: 'credit', color: 'bg-gradient-to-r from-rose-700 to-pink-900', limit: 100000, tags: ['æŒ‡å®š 7%', 'AP 4%', 'ä¸€èˆ¬ 2.5%'], desc: "â˜…æŒ‡å®š11å¤§é€šè·¯ 7% (éœ€Apple Payï¼Œä½æ¶ˆ100å°å¹£)ï¼š\n7-11ã€å…¨å®¶ã€Lawsonã€Bic Cameraã€Yodobashiã€å”å‰è¨¶å¾·ã€æ°¸æ—º(AEON)ã€å¤§ä¸¸ã€ä¸‰è¶Šã€é«˜å³¶å±‹ã€è¿ªå£«å°¼ã€ç’°çƒå½±åŸã€‚\nâ˜…Apple Pay 4%ï¼š1.5%åŠ ç¢¼ä¸Šé™ NT$600 (åˆ·ç´„4è¬)ã€‚" },
                { id: 'kumamon', name: 'ç‰å±±ç†Šæœ¬ç†Šå¡', reward: 'æŒ‡å®š 8.5% / PayPay 5%', type: 'credit', color: 'bg-gradient-to-r from-slate-700 to-slate-900', limit: 41500, tags: ['Suica 8.5%', 'è—¥å¦ 8.5%', 'å”å‰ 8.5%', 'Uniqlo 8.5%'], desc: "â˜…æŒ‡å®šé€šè·¯ 8.5%ï¼šBic Cameraã€Yodobashiã€æ¾æœ¬æ¸…ã€å”å‰è¨¶å¾·ã€å¤§åœ‹è—¥å¦ã€Tomod'sã€Uniqloã€GUã€ç„¡å°è‰¯å“ã€Suicaå„²å€¼ã€‚(åŠ ç¢¼ä¸Šé™ NT$500ï¼Œåˆ·ç´„ NT$8,333)ã€‚\nâ˜…ä¸€èˆ¬æ¶ˆè²»ï¼š2% (é›™å¹£å¡å…æ”¶1.5%æ‰‹çºŒè²»)ã€‚" },
                { id: 'dbs_eco', name: 'æ˜Ÿå±• eco æ°¸çºŒå¡', reward: 'å¯¦é«”å¡ 5% (ä¸Šé™ 1.5è¬)', type: 'credit', color: 'bg-gradient-to-r from-emerald-600 to-emerald-800', limit: 75000, tags: ['å¯¦é«”å¡ 5%', 'ç„¡è…¦åˆ·', 'æ­ç¾æ—¥éŸ“'], desc: "ã€2026æµ·å¤–å¯¦é«”å¡ç¥å¡ã€‘\næ—¥æœ¬/éŸ“åœ‹/æ–°/æ³°/ç¾/æ­å¯¦é«”åˆ·å¡äº« 5% (1%ç„¡ä¸Šé™+4%åŠ ç¢¼)ã€‚\nåŠ ç¢¼æœˆä¸Šé™ NT$600 (åˆ·ç´„ NT$15,000)ã€‚è¶…éå¾Œå›é¥‹ 1% ç„¡ä¸Šé™ã€‚ç„¡è…¦åˆ·é¦–é¸ã€‚" },
                { id: 'unicard', name: 'ç‰å±± Unicard (Upé¸)', reward: 'Upé¸ 4.5% (ä¸Šé™ 14è¬)', type: 'credit', color: 'bg-gradient-to-r from-violet-600 to-fuchsia-800', limit: 710000, tags: ['å¤§é¡ > 3è¬', 'ç²¾å“/å®¶é›»', '4.5%'], desc: "ã€å·²è¨‚é–±Upé¸æ–¹æ¡ˆ (æœˆè²» NT$99)ã€‘\nç™¾å¤§é€šè·¯(å«æ—¥æœ¬) 4.5% å›é¥‹ã€‚å›é¥‹ä¸Šé™ 5,000é» (åˆ·ç´„ NT$14.2è¬)ã€‚\næ”»ç•¥ï¼šå–®æœˆæ—¥æœ¬æ¶ˆè²» > 3è¬å°å¹£æ™‚ï¼Œå›é¥‹ç‡å‹éå‰é¶´å¡ã€‚é©åˆï¼šç²¾å“ã€é«˜å–®åƒ¹å®¶é›»ã€å¤§é‡æ¡è³¼ã€‚" },
                { id: 'suica', name: 'Mobile Suica', reward: 'äº¤é€š/è¶…å•†/è²©è³£æ©Ÿ', type: 'transport', color: 'bg-gradient-to-r from-emerald-800 to-emerald-900', limit: 0, tags: ['äº¤é€š', 'è²©è³£æ©Ÿ', 'è¶…å•†'], desc: "å»ºè­°ç¶å®šç†Šæœ¬ç†Šå¡ (8.5%) æˆ–å‰é¶´å¡ (0%å›é¥‹ä½†æ–¹ä¾¿)ã€‚" },
                { id: 'cash', name: 'æ—¥å¹£ç¾é‡‘', reward: 'å‰©é¤˜ Â¥21,622', type: 'cash', color: 'bg-gradient-to-r from-amber-700 to-amber-900', limit: 0, tags: ['è€åº—', 'è·¯é‚Šæ”¤'], desc: "ä¸»è¦ç”¨æ–¼ä¸æ”¶ä¿¡ç”¨å¡çš„å‚³çµ±åº—å®¶ã€æŠ•å¹£æ©Ÿã€éƒ¨åˆ†é–€ç¥¨ã€‚" }
            ];

            // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåˆå§‹åŒ–æ™‚é€²è¡Œè³‡æ–™åˆä½µ (Data Merge) â˜…â˜…â˜…
            const [cards, setCards] = useState(() => {
                const saved = safeJsonParse('cards', []);
                if (!saved || saved.length === 0) return DEFAULT_CARDS_DATA;
                
                // å°‡èˆŠè³‡æ–™èˆ‡æ–°é è¨­è³‡æ–™åˆä½µï¼Œå¼·åˆ¶æ›´æ–° desc å’Œ tags
                return saved.map(card => {
                    const defaultCard = DEFAULT_CARDS_DATA.find(d => d.id === card.id);
                    if (defaultCard) {
                        return {
                            ...card,
                            desc: defaultCard.desc, // å¼·åˆ¶æ›´æ–°æ”»ç•¥
                            tags: defaultCard.tags, // å¼·åˆ¶æ›´æ–°æ¨™ç±¤
                            // å¯ä»¥é¸æ“‡æ€§æ›´æ–° reward æˆ– nameï¼Œä½†ä¿ç•™ä½¿ç”¨è€…å¯èƒ½ä¿®æ”¹éçš„ limit æˆ– color
                        };
                    }
                    return card;
                });
            });

            // Persist Data
            useEffect(() => { localStorage.setItem('expenses', JSON.stringify(expenses)); }, [expenses]);
            useEffect(() => { localStorage.setItem('shoppingList', JSON.stringify(shoppingList)); }, [shoppingList]);
            useEffect(() => { localStorage.setItem('cards', JSON.stringify(cards)); }, [cards]);
            useEffect(() => { localStorage.setItem('budget', JSON.stringify(budget)); }, [budget]);
            useEffect(() => { localStorage.setItem('savedLinks', JSON.stringify(savedLinks)); }, [savedLinks]);

            // Memoized Stats
            const { totalSpent, remainingCash, categoryStats, cardSpendMap } = useMemo(() => {
                let total = 0, cashSpent = 0;
                const stats = { shopping: 0, dining: 0, transport: 0, other: 0 };
                const cardMap = {};
                (expenses || []).forEach(exp => {
                    const cost = Number(exp.cost) || 0;
                    total += cost;
                    if (stats[exp.category] !== undefined) stats[exp.category] += cost; else stats['other'] += cost;
                    if (exp.cardId === 'cash') cashSpent += cost;
                    cardMap[exp.cardId] = (cardMap[exp.cardId] || 0) + cost;
                });
                return { totalSpent: total, remainingCash: INITIAL_CASH - cashSpent, categoryStats: stats, cardSpendMap: cardMap };
            }, [expenses]);
            
            const filteredExpenses = useMemo(() => {
                if (!searchTerm) return expenses;
                const term = searchTerm.toLowerCase();
                return expenses.filter(exp => 
                    exp.item.toLowerCase().includes(term) || 
                    (exp.note && exp.note.toLowerCase().includes(term)) ||
                    (cards.find(c => c.id === exp.cardId)?.name || '').toLowerCase().includes(term) ||
                    (exp.forWho && exp.forWho.toLowerCase().includes(term)) // Include 'forWho' in search
                );
            }, [expenses, searchTerm, cards]);

            const showToast = (msg) => { setToastMsg(msg); setTimeout(() => setToastMsg(''), 2500); };
            const confirmAction = (title, msg, action) => setConfirmModal({ open: true, title, msg, onConfirm: action });
            const promptAction = (title, value, action) => setPromptModal({ open: true, title, value, onConfirm: action });

            const handleDeleteShoppingItem = (category, index) => {
                confirmAction('åˆªé™¤å•†å“', 'ç¢ºå®šè¦åˆªé™¤é€™å€‹å•†å“å—ï¼Ÿ', () => {
                    const newList = { ...shoppingList };
                    if (newList[category]) newList[category] = newList[category].filter((_, i) => i !== index);
                    setShoppingList(newList);
                    showToast('å•†å“å·²åˆªé™¤');
                    setConfirmModal({ ...confirmModal, open: false });
                });
            };

            const addExpense = () => {
                if (!newExpense.item || !newExpense.cost) { showToast('è«‹è¼¸å…¥é …ç›®èˆ‡é‡‘é¡'); return; }
                let selectedCardId = newExpense.cardId;
                if (!selectedCardId) {
                    const rec = getRecommendedCard(newExpense.category, newExpense.item, newExpense.cost, cardSpendMap);
                    selectedCardId = rec ? rec.id : 'cash';
                }
                const expense = { id: Date.now(), ...newExpense, cardId: selectedCardId, cost: Number(newExpense.cost) };
                setExpenses([expense, ...expenses]); // Add to top
                setNewExpense({ ...newExpense, item: '', cost: '', category: 'shopping', cardId: '', note: '', forWho: 'å€‹äºº' });
                showToast('è¨˜å¸³æˆåŠŸ');
            };
            
            const deleteExpense = (id) => {
                 confirmAction('åˆªé™¤ç´€éŒ„', 'ç¢ºå®šè¦åˆªé™¤é€™ç­†æ¶ˆè²»å—ï¼Ÿ', () => {
                    setExpenses(expenses.filter(e => e.id !== id));
                    setConfirmModal({ ...confirmModal, open: false });
                    showToast('ç´€éŒ„å·²åˆªé™¤');
                });
            };

            const getRecommendedCard = (category, item, cost, currentSpendMap = {}) => {
                if (!cards || cards.length === 0) return { name: 'è¼‰å…¥ä¸­...', id: 'loading' };
                if (!item) return cards.find(c => c.type === 'credit') || cards[0];
                const lowerItem = item.toLowerCase();
                const costNum = Number(cost) || 0;
                const checkLimit = (cardId) => {
                    const card = cards.find(c => c.id === cardId);
                    if (!card) return false;
                    if (!card.limit || card.limit === 0) return true;
                    return ((currentSpendMap[cardId] || 0) + costNum) <= card.limit;
                };

                const isKumamon = /bic|yodo|donki|å”å‰|uniqlo|gu|muji|ç„¡å°|æ¾æœ¬æ¸…|å¤§åœ‹|è—¥å¦/.test(lowerItem);
                const isJihe = /bic|yodo|donki|å”å‰|ä¸‰è¶Š|é«˜å³¶å±‹|æ°¸æ—º|aeon|edion|å¤§ä¸¸|è¿ªå£«å°¼|ç’°çƒ/.test(lowerItem);
                
                if (isKumamon) {
                    if (checkLimit('kumamon')) return { ...cards.find(c => c.id === 'kumamon'), isHighlight: true, reason: 'ğŸ”¥ æŒ‡å®š 8.5%' };
                    if (isJihe && checkLimit('jihe')) return { ...cards.find(c => c.id === 'jihe'), isHighlight: true, reason: 'âš ï¸ ç†Šæœ¬ç†Šæ»¿->å‰é¶´7%' };
                }
                if (category === 'transport' || /è¶…å•†|ä¾¿åˆ©å•†åº—|7-11|å…¨å®¶|lawson/.test(lowerItem)) return { ...cards.find(c => c.id === 'suica'), isHighlight: false };
                if (isJihe && checkLimit('jihe')) return { ...cards.find(c => c.id === 'jihe'), isHighlight: true, reason: 'âš¡ å‰é¶´æŒ‡å®š 7%' };
                
                return cards.find(c => c.id === 'jihe') || cards[0];
            };

            const currentRecommendation = getRecommendedCard(newExpense.category, newExpense.item, newExpense.cost, cardSpendMap) || {};

            const handleSmartAnalysis = () => {
                setIsSmartAnalyzing(true);
                setTimeout(() => {
                    const text = smartInputText;
                    let price = '', name = text, location = 'æœªçŸ¥';
                    const priceMatch = text.match(/[Â¥$] ?(\d{1,3}(,\d{3})*)/) || text.match(/(\d{1,3}(,\d{3})*) ?[å††å…ƒ]/);
                    if (priceMatch) { price = "Â¥" + priceMatch[1]; name = name.replace(priceMatch[0], '').trim(); }
                    const locs = ['æ©Ÿå ´', 'å°æ¨½', 'æœ­å¹Œ', 'ç‹¸å°è·¯', 'ç™»åˆ¥', 'å‡½é¤¨', 'Bic', 'Yodo', 'è—¥å¦', 'Donki'];
                    for (let loc of locs) if (text.includes(loc)) { location = loc; name = name.replace(loc, '').trim(); break; }
                    setNewItemData(prev => ({ ...prev, name: name.replace(/[:ï¼š]/g, '').trim(), price, location, desc: 'è‡ªå‹•åˆ†æçµæœ' }));
                    setIsSmartAnalyzing(false);
                }, 600);
            };

            const handleAddOrUpdateShoppingItem = () => {
                if (!newItemData.name && !newItemData.image) { showToast('è«‹è¼¸å…¥åç¨±æˆ–åœ–ç‰‡'); return; }
                const item = { ...newItemData, name: newItemData.name || 'æœªå‘½åå•†å“' };
                const cat = activeShoppingTab;
                const list = { ...shoppingList };
                if (!list[cat]) list[cat] = [];
                if (editingShoppingIndex !== null) list[cat][editingShoppingIndex] = item; else list[cat].push(item);
                setShoppingList(list);
                setNewItemData({ name: '', price: '', location: '', desc: '', image: null });
                setEditingShoppingIndex(null);
                setShowAddItemModal(false);
                showToast('å„²å­˜æˆåŠŸ');
            };

            const handleImageChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        const max = 800;
                        let w = img.width, h = img.height;
                        if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } }
                        cvs.width = w; cvs.height = h;
                        cvs.getContext('2d').drawImage(img, 0, 0, w, h);
                        setNewItemData(p => ({ ...p, image: cvs.toDataURL('image/jpeg', 0.7) }));
                    };
                    img.src = ev.target.result;
                };
                reader.readAsDataURL(file);
            };

            const rotateImage = () => {
                if (!newItemData.image) return;
                const img = new Image();
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    cvs.width = img.height; cvs.height = img.width;
                    const ctx = cvs.getContext('2d');
                    ctx.translate(cvs.width/2, cvs.height/2);
                    ctx.rotate(90 * Math.PI/180);
                    ctx.drawImage(img, -img.width/2, -img.height/2);
                    setNewItemData(p => ({ ...p, image: cvs.toDataURL('image/jpeg', 0.7) }));
                };
                img.src = newItemData.image;
            };

            const handleSaveCard = () => {
                if (!newCardData.name) { showToast('è«‹è¼¸å…¥åç¨±'); return; }
                const newCard = { ...newCardData, id: editingCardId || `custom_${Date.now()}`, limit: Number(newCardData.limit), tags: newCardData.tags || [] };
                setCards(editingCardId ? cards.map(c => c.id === editingCardId ? newCard : c) : [...cards, newCard]);
                setNewCardData({ name: '', reward: '', type: 'credit', color: 'bg-slate-700', desc: '', limit: '', tags: [] });
                setShowAddCardModal(false);
                setEditingCardId(null);
                showToast('å¡ç‰‡å·²å„²å­˜');
            };

            const handleDeleteCard = (id) => {
                if (id === 'cash') { showToast('ç„¡æ³•åˆªé™¤ç¾é‡‘'); return; }
                confirmAction('åˆªé™¤å¡ç‰‡', 'ç¢ºå®šè¦åˆªé™¤é€™å¼µå¡ç‰‡å—ï¼Ÿ', () => {
                    setCards(cards.filter(c => c.id !== id));
                    setConfirmModal({ ...confirmModal, open: false });
                    showToast('å¡ç‰‡å·²åˆªé™¤');
                });
            };

            const handleResetData = () => {
                confirmAction('é‡ç½®è³‡æ–™', 'é€™å°‡æ¸…é™¤æ‰€æœ‰è³‡æ–™ä¸”ç„¡æ³•å¾©åŸï¼', () => {
                    localStorage.clear();
                    window.location.reload();
                });
            };

            const handleAddOrUpdateLink = () => {
                if (!newLinkData.url) { showToast('è«‹è¼¸å…¥ç¶²å€'); return; }
                if (editingLinkId) {
                    setSavedLinks(savedLinks.map(l => l.id === editingLinkId ? { ...l, ...newLinkData } : l));
                    setEditingLinkId(null);
                    showToast('é€£çµå·²æ›´æ–°');
                } else {
                    setSavedLinks([...savedLinks, { id: Date.now(), ...newLinkData, title: newLinkData.title || 'æœªå‘½åé€£çµ' }]);
                    showToast('é€£çµå·²æ–°å¢');
                }
                setNewLinkData({ title: '', url: '' });
            };
            
            const handleEditLink = (link) => {
                setNewLinkData({ title: link.title, url: link.url });
                setEditingLinkId(link.id);
            };

            // Added: Cancel Edit Link
            const handleCancelEditLink = () => {
                setNewLinkData({ title: '', url: '' });
                setEditingLinkId(null);
            };

            const handleDeleteLink = (id) => {
                 confirmAction('åˆªé™¤é€£çµ', 'ç¢ºå®šè¦åˆªé™¤é€™å€‹é€£çµå—ï¼Ÿ', () => {
                    setSavedLinks(savedLinks.filter(l => l.id !== id));
                    setConfirmModal({ ...confirmModal, open: false });
                    showToast('é€£çµå·²åˆªé™¤');
                 });
            };

            const handleMealClick = useCallback((type, content, recs) => {
                if (!recs || recs.length === 0) return;
                setSelectedMealInfo({
                    title: type === 'breakfast' ? 'æ—©é¤æ¨è–¦' : type === 'lunch' ? 'åˆé¤æ¨è–¦' : 'æ™šé¤æ¨è–¦',
                    items: recs
                });
                setShowMealModal(true);
            }, []);

            return (
                <div className="max-w-md mx-auto h-screen bg-[#2E4057] flex flex-col font-sans text-[#EDF6FC] relative selection:bg-[#F4B942]/50">
                    <HideScrollbarStyle />
                    <LuxuryHeader dayInfo={{...DEFAULT_ITINERARY[activeDay], index: activeDay}} activeTab={activeTab}/>

                    {/* Day Navigation */}
                    {activeTab === 'itinerary' && (
                        <div className="bg-[#2E4057] px-5 pb-3 pt-4 z-30 shrink-0 shadow-md border-b border-[#819FA1]/30 relative -mt-12 rounded-t-[2.5rem]">
                            <div className="mb-3 bg-[#EDF6FC] p-3 rounded-xl border border-[#819FA1]/20 flex items-center gap-3 shadow-md">
                                <div className="bg-[#2E4057]/10 p-2 rounded-full text-[#2E4057]"><Shirt size={16} /></div>
                                <div className="min-w-0">
                                    <span className="font-bold text-[#2E4057] block text-[10px] uppercase tracking-wider mb-0.5">OUTFIT</span>
                                    <p className="text-xs text-[#819FA1] font-medium truncate">{DEFAULT_ITINERARY[activeDay].clothing}</p>
                                </div>
                                <button onClick={() => setShowOutfitModal(true)} className="ml-auto text-[#F4B942] bg-[#2E4057] p-1.5 rounded-lg border border-[#F4B942]/30 text-[10px] font-bold">INFO</button>
                            </div>
                            <div className="flex gap-2">
                                {DEFAULT_ITINERARY.map((day, idx) => (
                                    <button key={idx} onClick={() => setActiveDay(idx)} className={`flex-1 py-1.5 rounded-lg flex flex-col items-center transition-all duration-300 border ${activeDay === idx ? 'bg-[#F4B942] text-[#2E4057] border-[#F4B942] shadow-lg' : 'bg-[#819FA1]/30 text-[#EDF6FC] border-transparent hover:bg-[#819FA1]/50'}`}>
                                        <span className="text-[9px] font-bold tracking-widest uppercase">Day</span>
                                        <span className="text-sm font-bold font-mono">{idx + 1}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <main className="flex-1 overflow-y-auto p-5 pb-28 no-scrollbar z-0">
                        {/* Tab Content Logic */}
                        {activeTab === 'itinerary' && (
                            <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                {DEFAULT_ITINERARY.map((day, idx) => {
                                    if (idx !== activeDay) return null;
                                    return (
                                        <Card key={idx} className="p-0 overflow-hidden border border-[#819FA1]/30">
                                            <div className="p-5 space-y-6">
                                                {day.flight && (
                                                    <div className="bg-gradient-to-r from-[#2E4057]/10 to-[#819FA1]/10 p-4 rounded-xl border border-[#2E4057]/20 mb-4 flex items-center gap-4">
                                                        <div className="bg-[#2E4057]/10 p-2.5 rounded-full text-[#2E4057]">{day.flight.type === 'departure' ? <PlaneTakeoff size={20}/> : <PlaneLanding size={20}/>}</div>
                                                        <div>
                                                            <div className="flex items-center gap-2 mb-1">
                                                                <span className="text-sm font-bold text-[#2E4057]">{day.flight.code}</span>
                                                                <span className="text-[10px] bg-[#2E4057]/10 px-2 py-0.5 rounded text-[#2E4057]">{day.flight.time}</span>
                                                            </div>
                                                            <div className="text-[10px] text-[#819FA1] font-medium">{day.flight.gather}</div>
                                                        </div>
                                                    </div>
                                                )}
                                                {day.meals && (
                                                    <div className="flex gap-2 mt-4 mb-2 overflow-x-auto no-scrollbar">
                                                    {['breakfast', 'lunch', 'dinner'].map(type => {
                                                        const hasRec = day.meals.recommendations?.[type];
                                                        const content = day.meals[type];
                                                        const icon = type === 'breakfast' ? <Coffee size={10}/> : type === 'lunch' ? <UtensilsCrossed size={10}/> : <Utensils size={10}/>;
                                                        const label = type === 'breakfast' ? 'æ—©é¤' : type === 'lunch' ? 'åˆé¤' : 'æ™šé¤';
                                                        
                                                        return (
                                                            <div 
                                                                key={type} 
                                                                onClick={() => handleMealClick(type, content, day.meals.recommendations?.[type])}
                                                                className={`flex-1 p-3 rounded-lg border flex flex-col items-center justify-center text-center min-w-[80px] transition-all relative overflow-hidden ${hasRec ? 'border-[#508991]/50 bg-[#508991]/5 cursor-pointer hover:shadow-md group' : 'border-[#819FA1]/20 bg-white/50'}`}
                                                            >
                                                                {hasRec && <div className="absolute top-0 right-0 w-2 h-2 bg-[#508991] rounded-bl-full shadow-[0_0_2px_#508991]"></div>}
                                                                <span className={`text-[10px] uppercase tracking-widest font-bold mb-1 flex items-center gap-1 ${hasRec ? 'text-[#508991]' : 'text-[#819FA1]'}`}>{icon}{label}</span>
                                                                <span className={`text-xs font-medium line-clamp-2 ${hasRec ? 'text-[#2E4057] font-bold' : 'text-[#819FA1]'}`}>{content}</span>
                                                            </div>
                                                        );
                                                    })}
                                                    </div>
                                                )}
                                                <div className="space-y-6">
                                                    {day.spots.map((spot, sIdx) => <SpotItem key={sIdx} spot={spot} sIdx={sIdx} />)}
                                                </div>
                                            </div>
                                        </Card>
                                    );
                                })}
                            </div>
                        )}

                        {activeTab === 'expenses' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 gap-4">
                                    <Card className="bg-[#2E4057] border-none text-[#EDF6FC] relative overflow-hidden shadow-xl">
                                        <div className="text-[#819FA1] text-[10px] font-bold tracking-widest mb-1 flex justify-between">
                                            TOTAL SPENT <Edit3 size={12} className="cursor-pointer text-[#F4B942]" onClick={() => promptAction('è¨­å®šç¸½é ç®—', budget, (val) => setBudget(parseInt(val)||0))}/>
                                        </div>
                                        <div className="text-2xl font-bold font-mono text-[#F4B942]">Â¥{totalSpent.toLocaleString()}</div>
                                        <div className="w-full bg-white/10 h-1 rounded-full mt-2 overflow-hidden"><div className={`h-full ${totalSpent>budget?'bg-red-500':'bg-[#F4B942]'}`} style={{width: `${budget>0?Math.min((totalSpent/budget)*100,100):0}%`}}></div></div>
                                    </Card>
                                    <Card className="border-none shadow-xl bg-white border border-[#819FA1]/20 text-[#2E4057]">
                                        <div className="opacity-60 text-[10px] font-bold tracking-widest mb-1">CASH LEFT</div>
                                        <div className="text-2xl font-bold font-mono">Â¥{remainingCash.toLocaleString()}</div>
                                    </Card>
                                </div>
                                
                                {/* Add Expense Form with Date Picker */}
                                <Card className="border border-[#819FA1]/30 shadow-xl bg-[#EDF6FC]">
                                    <h3 className="font-bold text-[#2E4057] mb-5 flex items-center gap-2 text-sm uppercase tracking-wider"><Plus size={14} className="text-[#F4B942]"/> Add Expense</h3>
                                    <div className="space-y-4">
                                        {/* Date and Name inputs side-by-side on larger screens, stacked on small */}
                                        <div className="flex gap-2">
                                            <input type="date" className="w-1/3 p-3 bg-white rounded-lg text-sm text-[#2E4057] font-mono appearance-none" value={newExpense.date} onChange={e=>setNewExpense({...newExpense, date: e.target.value})} />
                                            <input type="text" placeholder="é …ç›®åç¨±" className="w-2/3 p-3 bg-white rounded-lg text-sm text-[#2E4057]" value={newExpense.item} onChange={e=>setNewExpense({...newExpense, item: e.target.value})} />
                                        </div>
                                        <div className="flex gap-3 relative">
                                            <input type="number" placeholder="Â¥ Price" className="flex-1 p-4 bg-white rounded-lg text-sm text-[#2E4057] font-mono" value={newExpense.cost} onChange={e=>setNewExpense({...newExpense, cost: e.target.value})} />
                                            <button 
                                                className="absolute right-[36%] top-2 p-2 text-[#2E4057] opacity-50 hover:opacity-100" 
                                                onClick={() => setShowCalculator(true)}
                                            >
                                                <Calculator size={18} />
                                            </button>
                                            <select className="w-[35%] p-4 bg-white rounded-lg text-sm text-[#2E4057]" value={newExpense.category} onChange={e=>setNewExpense({...newExpense, category: e.target.value})}>
                                                <option value="shopping">è³¼ç‰©</option><option value="dining">ç¾é£Ÿ</option><option value="transport">äº¤é€š</option><option value="other">å…¶ä»–</option>
                                            </select>
                                        </div>
                                        
                                        {/* NEW: Who is this for? */}
                                        <div className="flex gap-2 items-center overflow-x-auto no-scrollbar py-1">
                                            <span className="text-xs text-[#819FA1] shrink-0 font-bold mr-1">å°è±¡:</span>
                                            {whoOptions.map(who => (
                                                <button 
                                                    key={who}
                                                    onClick={() => setNewExpense({...newExpense, forWho: who})}
                                                    className={`px-3 py-1 rounded-full text-xs transition-all border ${newExpense.forWho === who ? whoColors[who] + ' border-transparent shadow-sm' : 'bg-white text-[#819FA1] border-[#819FA1]/30'}`}
                                                >
                                                    {who}
                                                </button>
                                            ))}
                                        </div>

                                        <input type="text" placeholder="å‚™è¨»/æ˜ç´°" className="w-full p-3 bg-white rounded-lg text-sm text-[#2E4057] border border-[#819FA1]/20" value={newExpense.note} onChange={e=>setNewExpense({...newExpense, note: e.target.value})} />

                                        <div className={`bg-white p-4 rounded-lg flex items-center justify-between shadow-sm ${currentRecommendation.isHighlight?'ring-2 ring-[#F4B942] bg-[#F4B942]/5':''}`}>
                                            <div className="flex items-center gap-3">
                                                <CreditCard size={16} className="text-[#2E4057]" />
                                                <div className="flex flex-col"><span className="text-[10px] font-bold uppercase text-[#F4B942]">{currentRecommendation.isHighlight?currentRecommendation.reason:'Recommended'}</span><span className="text-sm font-bold text-[#2E4057]">{currentRecommendation.name}</span></div>
                                            </div>
                                        </div>
                                        {/* Manual Card Selection */}
                                        <div className="flex gap-2 overflow-x-auto py-2 no-scrollbar">
                                            {cards.map(card => (
                                                <button 
                                                    key={card.id} 
                                                    onClick={() => setNewExpense({...newExpense, cardId: card.id})}
                                                    className={`flex-shrink-0 px-3 py-1.5 rounded-lg text-xs border transition-all whitespace-nowrap ${newExpense.cardId === card.id ? 'bg-[#2E4057] text-[#F4B942] border-[#2E4057]' : 'bg-white text-[#819FA1] border-[#819FA1]/30'}`}
                                                >
                                                    {card.name}
                                                </button>
                                            ))}
                                        </div>
                                        <Button onClick={addExpense} className="w-full py-4 mt-2 shadow-lg">SAVE</Button>
                                    </div>
                                    
                                    {/* Search Bar - Moved inside the card below the save button */}
                                    <div className="mt-6 pt-6 border-t border-[#819FA1]/20">
                                        <div className="relative">
                                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-[#819FA1]" size={16} />
                                            <input type="text" placeholder="æœå°‹æ¶ˆè²»ç´€éŒ„ (é …ç›®/é¡åˆ¥/å°è±¡)..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} className="w-full pl-10 p-3 bg-white rounded-xl border border-[#819FA1]/10 text-sm text-[#2E4057] focus:outline-none focus:border-[#2E4057]" />
                                        </div>
                                    </div>
                                </Card>
                                
                                {/* Expense List */}
                                <div className="space-y-3 pb-20">
                                    {filteredExpenses.length > 0 ? (
                                        filteredExpenses.map(exp => {
                                            const cardName = cards.find(c => c.id === exp.cardId)?.name || 'æœªçŸ¥';
                                            return (
                                                <div key={exp.id} className="bg-white p-3 rounded-xl border border-[#819FA1]/10 flex justify-between items-center shadow-sm relative overflow-hidden">
                                                    <div className={`absolute left-0 top-0 bottom-0 w-1 ${whoColors[exp.forWho || 'å€‹äºº'].split(' ')[0].replace('bg-', 'bg-').replace('100', '400')}`}></div>
                                                    <div className="flex-1 pl-2">
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <span className="text-[10px] font-mono text-[#819FA1] bg-[#2E4057]/5 px-1.5 py-0.5 rounded">{exp.date || '----/--/--'}</span>
                                                            <span className={`text-[9px] px-1.5 py-0.5 rounded-full ${whoColors[exp.forWho || 'å€‹äºº']}`}>{exp.forWho || 'å€‹äºº'}</span>
                                                        </div>
                                                        <div className="font-bold text-[#2E4057] text-sm">{exp.item}</div>
                                                        <div className="text-[10px] text-[#819FA1] mt-0.5 flex gap-2">
                                                            <span>{cardName}</span>
                                                            {exp.note && <span className="text-[#2E4057]/70 border-l border-[#819FA1]/30 pl-2 truncate max-w-[120px]">{exp.note}</span>}
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="font-mono font-bold text-[#2E4057]">Â¥{exp.cost.toLocaleString()}</div>
                                                        <button onClick={()=>deleteExpense(exp.id)} className="text-red-300 p-2 -mr-2"><Trash2 size={14}/></button>
                                                    </div>
                                                </div>
                                            );
                                        })
                                    ) : (
                                        <div className="text-center py-10 text-[#819FA1] text-xs">
                                            <p>æ²’æœ‰æ‰¾åˆ°æ¶ˆè²»ç´€éŒ„</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'cards' && (
                            <div className="space-y-6">
                                <div className="bg-[#EDF6FC] border border-[#819FA1]/20 rounded-xl p-5 shadow-sm">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold flex items-center gap-2 text-[#2E4057]"><Wallet size={18} className="text-[#D97706]"/> ä»˜æ¬¾æ±ºç­–æŒ‡å—</h3>
                                        <div className="flex gap-2">
                                            <button onClick={handleResetData}><RotateCcw size={16} className="text-red-400"/></button>
                                            <button onClick={()=>setShowAddCardModal(true)}><Plus size={16} className="text-[#F4B942]"/></button>
                                            <button onClick={()=>setIsEditingCards(!isEditingCards)}><Edit3 size={16} className="text-[#819FA1]"/></button>
                                        </div>
                                    </div>
                                    <div className="space-y-3 relative pl-4 border-l-2 border-[#F4B942]/30">
                                        {[
                                            {icon: Banknote, color: 'text-[#819FA1]', title: 'åªæ”¶ç¾é‡‘', val: 'Â¥ ç¾é‡‘'},
                                            {icon: Smartphone, color: 'text-[#224870]', title: 'è¶…å•†/äº¤é€š', val: 'Suica (8.5%)'},
                                            {icon: Store, color: 'text-[#F4B942]', title: 'æŒ‡å®šé€šè·¯', val: 'ç†Šæœ¬ç†Š (8.5%)'},
                                            {icon: CreditCard, color: 'text-[#2E4057]', title: 'ä¸€èˆ¬åº—å®¶', val: 'å‰é¶´AP (4%)'}
                                        ].map((step, i) => (
                                            <div key={i} className="flex justify-between items-center bg-white p-2 rounded border border-[#819FA1]/10">
                                                <div className="flex items-center gap-2"><step.icon size={14} className={step.color}/><span className="text-xs font-bold text-[#2E4057]">{step.title}</span></div>
                                                <span className="text-xs font-mono font-bold text-[#D97706]">{step.val}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                {cards.map(card => {
                                    const spend = cardSpendMap[card.id] || 0;
                                    const progress = card.limit > 0 ? Math.min((spend/card.limit)*100, 100) : 0;
                                    return (
                                        <div key={card.id} className={`p-6 rounded-2xl shadow-xl relative overflow-hidden text-white ${card.color}`}>
                                            <div className="flex justify-between items-start relative z-10">
                                                <div>
                                                    <div className="flex items-center gap-2"><h3 className="font-bold text-lg">{card.name}</h3>{isEditingCards && <button onClick={()=>handleDeleteCard(card.id)}><Trash2 size={16}/></button>}</div>
                                                    <div className="flex flex-wrap gap-1 mt-2">{(card.tags||[]).map((t,i)=><span key={i} className="text-[9px] bg-black/20 px-2 py-0.5 rounded backdrop-blur-sm">{t}</span>)}</div>
                                                </div>
                                                {card.limit > 0 && <div className="text-[10px] font-bold">{Math.round(progress)}%</div>}
                                            </div>
                                            <div className="mt-4 pt-3 border-t border-white/10 flex justify-between items-end relative z-10">
                                                <span className="text-xs opacity-80">Spent</span>
                                                <div className="text-right"><div className="font-mono text-xl font-bold">Â¥{spend.toLocaleString()}</div><div className="text-[9px] opacity-70">â‰ˆ NT${Math.round(spend*EXCHANGE_RATE).toLocaleString()}</div></div>
                                            </div>
                                            {card.limit > 0 && <div className="mt-1 text-[9px] text-right text-white/60">ä¸Šé™: Â¥{card.limit.toLocaleString()} (ç´„ NT${Math.round(card.limit * EXCHANGE_RATE).toLocaleString()})</div>}
                                            {card.limit > 0 && progress >= 100 && <div className="mt-2 bg-red-500/80 text-white text-[10px] px-2 py-1 rounded flex items-center gap-1"><AlertCircle size={10}/> å·²é”ä¸Šé™</div>}
                                            {/* â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ æ¨™é¡Œè®“æ”»ç•¥æ›´æ˜é¡¯ â˜…â˜…â˜… */}
                                            {card.desc && (
                                                <div className="mt-4 bg-black/30 p-3 rounded-lg backdrop-blur-md border border-white/5 relative z-10">
                                                    <div className="text-[10px] font-bold text-[#F4B942] mb-1 flex items-center gap-1"><Lightbulb size={10}/> åˆ·å¡æ”»ç•¥</div>
                                                    <div className="text-[10px] text-white/80 leading-relaxed whitespace-pre-wrap">{card.desc}</div>
                                                </div>
                                            )}
                                        </div>
                                    )
                                })}
                            </div>
                        )}
                        
                        {/* Shopping Tab */}
                        {activeTab === 'shopping' && (
                             <div className="space-y-4 pb-20">
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{Object.keys(shoppingList).map(cat => <button key={cat} onClick={()=>setActiveShoppingTab(cat)} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all border ${activeShoppingTab===cat?'bg-[#F4B942] text-[#2E4057]':'bg-white text-[#819FA1]'}`}>{cat}</button>)}</div>
                                
                                {/* Location Filter */}
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar pl-1">
                                    <button onClick={()=>setSelectedLocation('å…¨éƒ¨')} className={`flex items-center gap-1 px-3 py-1 rounded-full text-[10px] font-bold border transition-all ${selectedLocation==='å…¨éƒ¨'?'bg-[#2E4057] text-white border-[#2E4057]':'bg-white text-[#819FA1] border-[#819FA1]/30'}`}>
                                        <MapPin size={10}/> å…¨éƒ¨
                                    </button>
                                    {['æ´çˆºæ¹–','å‡½é¤¨','ç™»åˆ¥','å°æ¨½','æœ­å¹Œ','æ©Ÿå ´'].map(loc => (
                                        <button key={loc} onClick={()=>setSelectedLocation(loc)} className={`flex-shrink-0 px-3 py-1 rounded-full text-[10px] font-bold border transition-all ${selectedLocation===loc?'bg-[#2E4057] text-white border-[#2E4057]':'bg-white text-[#819FA1] border-[#819FA1]/30'}`}>
                                            {loc}
                                        </button>
                                    ))}
                                </div>

                                <div className="flex justify-end mb-2"><button onClick={()=>{setNewItemData({name:'',price:'',location:'',desc:'',image:null});setEditingShoppingIndex(null);setShowAddItemModal(true)}} className="bg-[#2E4057] text-white p-2 rounded-full shadow-lg"><Plus size={20}/></button></div>
                                
                                {(shoppingList[activeShoppingTab]||[])
                                    .filter(item => selectedLocation === 'å…¨éƒ¨' || (item.location && item.location.includes(selectedLocation.replace('æ©Ÿå ´', 'æ–°åƒæ­²'))))
                                    .map((item,i) => (
                                    <div key={i} className="bg-white p-3 rounded-xl flex gap-3 shadow-sm" onClick={()=>{setNewItemData(item);setEditingShoppingIndex(i);setShowAddItemModal(true)}}>
                                        {item.image && <img src={item.image} className="w-16 h-16 rounded object-cover shrink-0" onClick={e=>{e.stopPropagation();setViewImage(item.image)}}/>}
                                        <div className="flex-1 min-w-0"><h4 className="font-bold text-[#2E4057] truncate">{item.name}</h4><p className="text-xs text-[#819FA1] truncate">{item.desc}</p><div className="flex justify-between mt-1"><span className="text-xs font-mono text-[#D97706]">{item.price}</span><span className="text-[10px] text-[#819FA1]">{item.location}</span></div></div>
                                        <button onClick={e=>{e.stopPropagation();handleDeleteShoppingItem(activeShoppingTab,i)}} className="text-red-300"><Trash2 size={16}/></button>
                                    </div>
                                ))}
                                {(shoppingList[activeShoppingTab]||[]).filter(item => selectedLocation === 'å…¨éƒ¨' || (item.location && item.location.includes(selectedLocation.replace('æ©Ÿå ´', 'æ–°åƒæ­²')))).length === 0 && (
                                    <div className="text-center text-[#819FA1] text-xs py-8">æ­¤åœ°é»å°šç„¡æ¨è–¦æ¸…å–®</div>
                                )}
                             </div>
                        )}

                        {/* Links Tab */}
                        {activeTab === 'links' && (
                             <div className="space-y-4">
                                <div className="flex gap-2 mb-4">
                                    <input 
                                        type="text" 
                                        placeholder={editingLinkId ? "ä¿®æ”¹æ¨™é¡Œ..." : "æ¨™é¡Œ"} 
                                        className={`flex-1 p-3 rounded-lg border text-sm transition-colors ${editingLinkId ? 'bg-amber-50 border-amber-300' : 'bg-white'}`} 
                                        value={newLinkData.title} 
                                        onChange={e=>setNewLinkData({...newLinkData, title:e.target.value})}
                                    />
                                    <input 
                                        type="text" 
                                        placeholder={editingLinkId ? "ä¿®æ”¹ç¶²å€..." : "ç¶²å€"} 
                                        className={`flex-1 p-3 rounded-lg border text-sm transition-colors ${editingLinkId ? 'bg-amber-50 border-amber-300' : 'bg-white'}`} 
                                        value={newLinkData.url} 
                                        onChange={e=>setNewLinkData({...newLinkData, url:e.target.value})}
                                    />
                                    <button onClick={handleAddOrUpdateLink} className={`bg-[#2E4057] text-white p-3 rounded-lg shadow-lg ${editingLinkId ? 'ring-2 ring-amber-400' : ''}`}>
                                        {editingLinkId ? <Save size={20}/> : <Plus size={20}/>}
                                    </button>
                                    {/* Added: Cancel Edit Button */}
                                    {editingLinkId && (
                                        <button onClick={handleCancelEditLink} className="bg-red-50 text-red-400 p-3 rounded-lg border border-red-200">
                                            <X size={20}/>
                                        </button>
                                    )}
                                </div>
                                {savedLinks.map(l => (
                                    <div key={l.id} className={`p-4 rounded-xl flex justify-between items-center shadow-sm transition-all ${editingLinkId === l.id ? 'bg-amber-50 border-amber-300 ring-1 ring-amber-300' : 'bg-white border border-[#819FA1]/20'}`}>
                                        <div className="flex items-center gap-3 overflow-hidden">
                                            <div className="bg-[#F4B942]/10 p-2 rounded-full text-[#F4B942]"><LinkIcon size={16}/></div>
                                            <div className="truncate">
                                                <div className="font-bold text-[#2E4057] text-sm">{l.title}</div>
                                                <div className="text-[10px] text-[#819FA1] truncate">{l.url}</div>
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <a href={l.url} target="_blank" rel="noopener noreferrer" className="p-2 bg-gray-100 rounded text-[#2E4057]"><ExternalLink size={16}/></a>
                                            <button onClick={()=>handleEditLink(l)} className="p-2 bg-blue-50 text-blue-400 rounded"><Pencil size={16}/></button>
                                            <button onClick={()=>handleDeleteLink(l.id)} className="p-2 bg-red-50 text-red-400 rounded"><Trash2 size={16}/></button>
                                        </div>
                                    </div>
                                ))}
                             </div>
                        )}
                    </main>

                    {/* Navbar */}
                    <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[95%] max-w-sm bg-[#EDF6FC]/95 backdrop-blur-xl border border-[#819FA1]/30 shadow-2xl rounded-full p-2 flex justify-between items-center z-50">
                        {['itinerary', 'shopping', 'expenses', 'cards', 'links'].map(tab => (
                            <button key={tab} onClick={() => setActiveTab(tab)} className={`flex flex-col items-center justify-center w-10 h-10 rounded-full transition-all ${activeTab===tab?'bg-[#2E4057] text-[#F4B942] -translate-y-1 shadow-lg':'text-[#819FA1]'}`}>
                                {tab==='itinerary'?<Calendar size={16}/>:tab==='shopping'?<Gift size={16}/>:tab==='expenses'?<DollarSign size={16}/>:tab==='cards'?<CreditCard size={16}/>:<LinkIcon size={16}/>}
                            </button>
                        ))}
                    </nav>

                    {/* Global Components */}
                    {toastMsg && <Toast message={toastMsg} onClose={() => setToastMsg('')} />}
                    {viewImage && <div className="fixed inset-0 bg-black/95 z-[120] flex justify-center items-center" onClick={()=>setViewImage(null)}><img src={viewImage} className="max-w-full max-h-full"/><button className="absolute top-5 right-5 text-white"><X size={32}/></button></div>}
                    
                    {/* Modals */}
                    <Modal isOpen={confirmModal.open} title={confirmModal.title} onClose={()=>setConfirmModal({...confirmModal, open:false})} actions={<><button onClick={()=>setConfirmModal({...confirmModal,open:false})} className="px-4 py-2 text-gray-500">å–æ¶ˆ</button><button onClick={confirmModal.onConfirm} className="px-4 py-2 bg-red-500 text-white rounded">ç¢ºèª</button></>}>
                        <p className="text-[#2E4057]">{confirmModal.msg}</p>
                    </Modal>

                    <Modal isOpen={promptModal.open} title={promptModal.title} onClose={()=>setPromptModal({...promptModal, open:false})} actions={<><button onClick={()=>setPromptModal({...promptModal,open:false})} className="px-4 py-2 text-gray-500">å–æ¶ˆ</button><button onClick={()=>{promptModal.onConfirm(promptModal.value);setPromptModal({...promptModal,open:false})}} className="px-4 py-2 bg-[#2E4057] text-[#F4B942] rounded">ç¢ºå®š</button></>}>
                        <input type="number" className="w-full p-3 border rounded font-mono" value={promptModal.value} onChange={e=>setPromptModal({...promptModal, value:e.target.value})} autoFocus />
                    </Modal>

                    <CalculatorModal 
                        isOpen={showCalculator} 
                        onClose={() => setShowCalculator(false)} 
                        initialValue={newExpense.cost}
                        onConfirm={(val) => setNewExpense({...newExpense, cost: val})}
                    />

                    {/* Add Item Modal */}
                    <Modal isOpen={showAddItemModal} title={editingShoppingIndex!==null?"ç·¨è¼¯å•†å“":"æ–°å¢å•†å“"} onClose={()=>setShowAddItemModal(false)}>
                        <div className="space-y-4">
                            <div className="flex gap-4">
                                <div className="w-20 h-20 bg-gray-100 rounded flex justify-center items-center overflow-hidden" onClick={()=>document.getElementById('imgUpload').click()}>
                                    {newItemData.image ? <img src={newItemData.image} className="w-full h-full object-cover"/> : <ImageIcon className="text-gray-400"/>}
                                </div>
                                <div className="flex-1 space-y-2">
                                    <button onClick={()=>document.getElementById('imgUpload').click()} className="w-full py-2 border rounded text-xs flex justify-center gap-2"><Upload size={14}/> ä¸Šå‚³åœ–ç‰‡</button>
                                    <button onClick={rotateImage} className="w-full py-2 border rounded text-xs flex justify-center gap-2"><RotateCw size={14}/> æ—‹è½‰</button>
                                    <input id="imgUpload" type="file" hidden accept="image/*" onChange={handleImageChange}/>
                                </div>
                            </div>
                            <input type="text" placeholder="å•†å“åç¨±" className="w-full p-3 border rounded" value={newItemData.name} onChange={e=>setNewItemData({...newItemData, name:e.target.value})}/>
                            <div className="flex gap-2">
                                <input type="text" placeholder="åƒ¹æ ¼" className="flex-1 p-3 border rounded" value={newItemData.price} onChange={e=>setNewItemData({...newItemData, price:e.target.value})}/>
                                <input type="text" placeholder="åœ°é»" className="flex-1 p-3 border rounded" value={newItemData.location} onChange={e=>setNewItemData({...newItemData, location:e.target.value})}/>
                            </div>
                            <input type="text" placeholder="å‚™è¨»" className="w-full p-3 border rounded" value={newItemData.desc} onChange={e=>setNewItemData({...newItemData, desc:e.target.value})}/>
                            <Button onClick={handleAddOrUpdateShoppingItem} className="w-full mt-2">å„²å­˜</Button>
                        </div>
                    </Modal>

                    {/* Add Card Modal */}
                    <Modal isOpen={showAddCardModal} title="ç·¨è¼¯å¡ç‰‡" onClose={()=>setShowAddCardModal(false)}>
                        <div className="space-y-3">
                            <input type="text" placeholder="åç¨±" className="w-full p-3 border rounded" value={newCardData.name} onChange={e=>setNewCardData({...newCardData, name:e.target.value})}/>
                            <input type="text" placeholder="å›é¥‹" className="w-full p-3 border rounded" value={newCardData.reward} onChange={e=>setNewCardData({...newCardData, reward:e.target.value})}/>
                            <input type="number" placeholder="ä¸Šé™ (æ—¥å¹£)" className="w-full p-3 border rounded" value={newCardData.limit} onChange={e=>setNewCardData({...newCardData, limit:e.target.value})}/>
                            <div className="flex gap-2">
                                {['bg-slate-700', 'bg-rose-700', 'bg-emerald-700', 'bg-indigo-700', 'bg-amber-700'].map(c => (
                                    <button key={c} onClick={()=>setNewCardData({...newCardData, color: c})} className={`w-6 h-6 rounded-full ${c} ${newCardData.color===c?'ring-2 ring-offset-2':''}`}></button>
                                ))}
                            </div>
                            <Button onClick={handleSaveCard} className="w-full mt-2">å„²å­˜</Button>
                        </div>
                    </Modal>
                    
                    <OutfitModal isOpen={showOutfitModal} onClose={() => setShowOutfitModal(false)} dayInfo={DEFAULT_ITINERARY[activeDay]} />
                    <MealModal isOpen={showMealModal} onClose={() => setShowMealModal(false)} mealInfo={selectedMealInfo} />
                </div>
            );
        }
        
        const container = document.getElementById('root');
        if (container) createRoot(container).render(<App />);
    </script>
</body>
</html>
